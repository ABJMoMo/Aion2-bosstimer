<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AION 2 Boss 重生計時器 (活動版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        aion: {
                            dark: '#0f172a',
                            card: '#1e293b',
                            accent: '#38bdf8', /* 天族藍 */
                            asmodian: '#f87171', /* 魔族紅 */
                            abyss: '#a78bfa', /* 深淵紫 */
                            gold: '#fbbf24',
                            danger: '#ef4444',
                            success: '#22c55e',
                            event: '#f472b6' /* 活動粉紅 */
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            --timer-color: #f472b6; /* 預設為活動色 */
        }
        /* Table Styles */
        .boss-row {
            transition: background-color 0.2s ease;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .boss-row:hover {
            background-color: rgba(30, 41, 59, 0.8);
        }
        .boss-row.spawned {
            background-color: rgba(34, 197, 94, 0.1);
            border-left: 4px solid #22c55e;
        }
        .boss-row.cooling {
             border-left: 4px solid transparent;
        }
        .boss-row.alert {
            animation: flash-red 1s infinite;
            border-left: 4px solid #fbbf24;
        }
        @keyframes flash-red {
            0%, 100% { background-color: rgba(251, 191, 36, 0.1); }
            50% { background-color: rgba(251, 191, 36, 0.25); }
        }

        .status-badge {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
        
        /* Custom Checkbox Styles */
        .filter-checkbox:checked + div {
            background-color: var(--active-bg);
            border-color: var(--active-border);
            color: white;
        }
        .filter-checkbox:checked + div .check-icon {
            opacity: 1;
            transform: scale(1);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans">

    <!-- Navbar -->
    <nav class="bg-slate-900 border-b border-slate-700 sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <i class="fa-solid fa-dragon text-aion-event text-2xl mr-3"></i>
                    <span class="font-bold text-xl tracking-wider text-white hidden md:inline">AION 2 <span class="text-aion-event text-sm ml-1 font-normal">BOSS 追蹤器 (活動版)</span></span>
                    <span class="font-bold text-xl tracking-wider text-white md:hidden">A2 <span class="text-aion-event text-sm ml-1">Boss</span></span>
                </div>
                <div class="flex space-x-2 items-center">
                    <!-- Sound Toggle -->
                    <button id="soundToggleBtn" onclick="toggleSound()" class="bg-slate-800 hover:bg-slate-700 text-slate-400 p-2 rounded-md transition border border-slate-600 mr-2" title="開啟/關閉提示音">
                        <i class="fa-solid fa-volume-xmark" id="soundIcon"></i>
                    </button>
                    
                    <!-- Multiplayer Button Group -->
                    <div class="flex items-center">
                        <button onclick="openRoomModal()" id="multiplayerBtn" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-md text-sm font-medium transition flex items-center border border-slate-600 mr-1">
                            <i class="fa-solid fa-users mr-2"></i> <span id="roomStatusText">多人連線</span>
                        </button>
                        <!-- Disconnect Button (Initially Hidden) -->
                        <button onclick="disconnectFromRoom()" id="disconnectBtn" class="hidden bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded-md text-sm font-medium transition items-center border border-red-500 mr-2" title="斷開連線">
                            <i class="fa-solid fa-power-off"></i>
                        </button>
                    </div>

                    <!-- Import Button -->
                    <label class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-md text-sm font-medium transition flex items-center cursor-pointer mr-2">
                        <i class="fa-solid fa-file-import mr-2"></i> 匯入
                        <input type="file" accept=".json" class="hidden" onchange="importData(this)">
                    </label>

                    <!-- Export Button -->
                    <button onclick="exportData()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-md text-sm font-medium transition flex items-center mr-2">
                        <i class="fa-solid fa-file-export mr-2"></i> 匯出
                    </button>

                    <button onclick="openModal()" class="bg-aion-event hover:bg-pink-500 text-slate-900 px-3 py-2 rounded-md text-sm font-bold transition flex items-center shadow-lg shadow-aion-event/20">
                        <i class="fa-solid fa-plus mr-1"></i> 新增
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Audio Element -->
    <audio id="alertSound" src="data:audio/wav;base64,UklGRl9vT1BXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...." preload="auto"></audio>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8">
        
        <!-- Filter Section -->
        <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 mb-6 backdrop-blur-sm">
            <div class="flex flex-col xl:flex-row justify-between items-center gap-4">
                <!-- Filters -->
                <div class="flex items-center gap-2 overflow-x-auto w-full xl:w-auto pb-2 xl:pb-0 scrollbar-hide">
                    <span class="text-slate-400 font-medium mr-2 whitespace-nowrap"><i class="fa-solid fa-filter mr-2"></i>顯示種族:</span>
                    <label class="cursor-pointer relative group flex-shrink-0">
                        <input type="checkbox" value="elyos" checked onchange="renderBosses()" class="filter-checkbox sr-only">
                        <div style="--active-bg: #0ea5e9; --active-border: #38bdf8;" class="px-4 py-2 rounded-lg bg-slate-800 border border-slate-600 text-slate-400 transition-all hover:bg-slate-700 flex items-center select-none group-hover:border-slate-500">
                            <i class="fa-solid fa-check mr-2 transition-all opacity-0 scale-50 w-0 check-icon"></i>
                            <span class="group-hover:text-white">天族</span>
                        </div>
                    </label>
                    <label class="cursor-pointer relative group flex-shrink-0">
                        <input type="checkbox" value="asmodian" checked onchange="renderBosses()" class="filter-checkbox sr-only">
                        <div style="--active-bg: #dc2626; --active-border: #f87171;" class="px-4 py-2 rounded-lg bg-slate-800 border border-slate-600 text-slate-400 transition-all hover:bg-slate-700 flex items-center select-none group-hover:border-slate-500">
                            <i class="fa-solid fa-check mr-2 transition-all opacity-0 scale-50 w-0 check-icon"></i>
                            <span class="group-hover:text-white">魔族</span>
                        </div>
                    </label>
                    <label class="cursor-pointer relative group flex-shrink-0">
                        <input type="checkbox" value="abyss" checked onchange="renderBosses()" class="filter-checkbox sr-only">
                        <div style="--active-bg: #7c3aed; --active-border: #a78bfa;" class="px-4 py-2 rounded-lg bg-slate-800 border border-slate-600 text-slate-400 transition-all hover:bg-slate-700 flex items-center select-none group-hover:border-slate-500">
                            <i class="fa-solid fa-check mr-2 transition-all opacity-0 scale-50 w-0 check-icon"></i>
                            <span class="group-hover:text-white">深淵</span>
                        </div>
                    </label>
                </div>
                
                <!-- Controls Right Side -->
                <div class="flex items-center gap-4 w-full xl:w-auto justify-between xl:justify-end">
                    <!-- Event Mode Badge -->
                    <div class="flex items-center mr-4 bg-slate-900/80 px-4 py-2 rounded-lg border border-pink-500/30">
                        <span class="text-sm font-bold text-aion-event animate-pulse"><i class="fa-solid fa-fire mr-2"></i>活動模式常駐</span>
                    </div>
                    <div class="text-sm text-slate-400 font-mono bg-slate-900 px-3 py-2 rounded border border-slate-700 whitespace-nowrap min-w-[80px] text-center" id="clock">--:--:--</div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Panel -->
        <div id="recentActivityPanel" class="hidden mb-6 bg-slate-800/80 border border-yellow-500/30 rounded-xl overflow-hidden shadow-lg animate-fade-in-down">
            <div class="bg-yellow-500/10 px-6 py-3 border-b border-yellow-500/20 flex justify-between items-center">
                <h3 class="text-yellow-400 font-bold text-sm uppercase tracking-wide flex items-center">
                    <i class="fa-solid fa-triangle-exclamation mr-2"></i> 最近異動 (自動判定擊殺)
                </h3>
                <span class="text-xs text-slate-400 bg-slate-900/50 px-2 py-1 rounded">顯示最新 10 筆 (10分鐘後自動忽略)</span>
            </div>
            <div id="recentActivityList" class="divide-y divide-slate-700/50 max-h-60 overflow-y-auto"></div>
        </div>

        <!-- Boss List (Table View) -->
        <div class="bg-slate-800 rounded-xl overflow-hidden shadow-xl border border-slate-700">
            <div class="grid grid-cols-12 gap-4 px-6 py-3 bg-slate-900 border-b border-slate-700 text-xs font-bold text-slate-400 uppercase tracking-wider hidden md:grid">
                <div class="col-span-5">Boss 名稱 [地區]</div>
                <div class="col-span-2 text-center">活動週期</div>
                <div class="col-span-3 text-center">狀態 / 倒數 / 上次擊殺</div>
                <div class="col-span-2 text-right">操作</div>
            </div>
            <div id="bossList" class="divide-y divide-slate-700"></div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-20 bg-slate-800/30 rounded-2xl border border-dashed border-slate-700 mt-6">
            <div class="inline-block p-6 rounded-full bg-slate-800 mb-4 shadow-lg"><i class="fa-solid fa-dragon text-4xl text-slate-600"></i></div>
            <h3 class="text-xl font-bold text-slate-400">目前沒有顯示的 Boss</h3>
            <p class="text-slate-500 mt-2">可能是篩選條件未勾選，或是資料已被清除。</p>
            <button onclick="loadDefaults()" class="mt-4 text-aion-event hover:underline text-sm font-medium">重置為 天族/魔族/深淵 預設資料</button>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-900 border-t border-slate-800 py-6 mt-8">
        <div class="container mx-auto px-4 text-center text-slate-500 text-sm">
            <p>資料儲存於您的瀏覽器 (Local Storage) 或 Firebase (若已連線)。</p>
            <p class="mt-1">&copy; 2025 AION 2 Boss Tracker.</p>
        </div>
    </footer>

    <!-- Modals -->
    <!-- Add/Edit Modal (Modified to only show Event Time) -->
    <div id="bossModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" aria-hidden="true" onclick="closeModal()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-slate-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full border border-slate-700">
                <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-bold text-white mb-6 border-b border-slate-700 pb-2" id="modalTitle">新增 Boss</h3>
                    <form id="bossForm" onsubmit="handleFormSubmit(event)">
                        <input type="hidden" id="bossId">
                        <div class="mb-5">
                            <label class="block text-sm font-medium text-slate-400 mb-2">所屬種族</label>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="cursor-pointer"><input type="radio" name="region" value="elyos" class="peer sr-only" required><div class="text-center py-2 rounded border border-slate-600 bg-slate-900 text-slate-400 peer-checked:bg-sky-900 peer-checked:border-sky-500 peer-checked:text-sky-400 transition-all hover:bg-slate-700">天族</div></label>
                                <label class="cursor-pointer"><input type="radio" name="region" value="asmodian" class="peer sr-only"><div class="text-center py-2 rounded border border-slate-600 bg-slate-900 text-slate-400 peer-checked:bg-red-900 peer-checked:border-red-500 peer-checked:text-red-400 transition-all hover:bg-slate-700">魔族</div></label>
                                <label class="cursor-pointer"><input type="radio" name="region" value="abyss" class="peer sr-only" checked><div class="text-center py-2 rounded border border-slate-600 bg-slate-900 text-slate-400 peer-checked:bg-purple-900 peer-checked:border-purple-500 peer-checked:text-purple-400 transition-all hover:bg-slate-700">深淵</div></label>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="bossName" class="block text-sm font-medium text-slate-400 mb-1">Boss 名稱</label>
                            <input type="text" id="bossName" required class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:border-aion-accent" placeholder="例如: 憤怒的庫爾卡">
                        </div>
                        <div class="mb-4 p-4 bg-slate-900/50 rounded border border-slate-700/50">
                            <div>
                                <h4 class="text-sm font-bold text-aion-event mb-2 border-b border-slate-700 pb-1">重生時間 (活動模式)</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="text-xs text-slate-500">小時</label><input type="number" id="eventHours" min="0" value="0" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-white focus:border-aion-event"></div>
                                    <div><label class="text-xs text-slate-500">分鐘</label><input type="number" id="eventMinutes" min="0" max="59" value="0" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-white focus:border-aion-event"></div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="bossLocation" class="block text-sm font-medium text-slate-400 mb-1">詳細位置</label>
                            <input type="text" id="bossLocation" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:border-aion-accent" placeholder="例如: 龍界南部">
                        </div>
                        <div class="bg-slate-900 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-slate-700 -mx-6 -mb-4 mt-6">
                            <button type="button" onclick="document.getElementById('bossForm').dispatchEvent(new Event('submit', {cancelable: true, bubbles: true}))" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-aion-event text-base font-medium text-slate-900 hover:bg-pink-500 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm shadow-lg shadow-pink-500/20">儲存</button>
                            <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-slate-600 shadow-sm px-4 py-2 bg-slate-800 text-base font-medium text-slate-300 hover:text-white hover:bg-slate-700 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">取消</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Time Edit Modal -->
    <div id="timeEditModal" class="fixed inset-0 z-[60] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 text-center sm:block sm:p-0">
             <div class="fixed inset-0 bg-gray-900 bg-opacity-80 transition-opacity backdrop-blur-sm" aria-hidden="true" onclick="closeTimeEditModal()"></div>
             <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
             <div class="inline-block align-bottom bg-slate-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm w-full border border-slate-700">
                <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-bold text-white mb-4">修改擊殺時間</h3>
                    <p class="text-sm text-slate-400 mb-4">請輸入過去的擊殺時間 (例如 1430, 143010)</p>
                    <input type="hidden" id="editTimeBossId">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-400 mb-1">擊殺時間 (HHMM 或 HHMMSS)</label>
                        <input type="text" id="manualKillTime" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:border-aion-accent font-mono text-lg" placeholder="例如: 1430" maxlength="8">
                        <p class="text-xs text-slate-500 mt-2">支援格式: 1430 (=14:30:00), 143010 (=14:30:10)</p>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                         <button type="button" onclick="closeTimeEditModal()" class="inline-flex justify-center rounded-md border border-slate-600 shadow-sm px-4 py-2 bg-slate-800 text-base font-medium text-slate-300 hover:text-white hover:bg-slate-700 focus:outline-none sm:text-sm">取消</button>
                         <button type="button" onclick="saveManualTime()" class="inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-aion-event text-base font-medium text-slate-900 hover:bg-pink-400 focus:outline-none sm:text-sm font-bold">確認修改</button>
                    </div>
                </div>
             </div>
        </div>
    </div>

    <!-- Room ID Modal -->
    <div id="roomModal" class="fixed inset-0 z-[70] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 text-center sm:block sm:p-0">
             <div class="fixed inset-0 bg-gray-900 bg-opacity-80 transition-opacity backdrop-blur-sm" aria-hidden="true" onclick="closeRoomModal()"></div>
             <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
             <div class="inline-block align-bottom bg-slate-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm w-full border border-slate-700">
                <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-bold text-white mb-2">多人連線設定</h3>
                    <p class="text-sm text-slate-400 mb-4">輸入相同的房間名稱，即可與隊友同步資料。</p>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-400 mb-1">房間名稱 (例如: 軍團名)</label>
                        <input type="text" id="roomNameInput" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:border-aion-accent">
                    </div>
                    <div class="flex justify-end gap-3 mt-4">
                         <button type="button" onclick="closeRoomModal()" class="inline-flex justify-center rounded-md border border-slate-600 shadow-sm px-4 py-2 bg-slate-800 text-base font-medium text-slate-300 hover:text-white hover:bg-slate-700 focus:outline-none sm:text-sm">取消</button>
                         <button type="button" onclick="connectToRoom()" class="inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-aion-event text-base font-medium text-slate-900 hover:bg-pink-400 focus:outline-none sm:text-sm font-bold">連線</button>
                    </div>
                </div>
             </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 z-[80] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 text-center sm:block sm:p-0">
             <div class="fixed inset-0 bg-gray-900 bg-opacity-80 transition-opacity backdrop-blur-sm" aria-hidden="true"></div>
             <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
             <div class="inline-block align-bottom bg-slate-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm w-full border border-slate-700">
                <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-slate-700 mb-4">
                        <i class="fa-solid fa-skull text-xl text-aion-danger"></i>
                    </div>
                    <h3 class="text-lg leading-6 font-bold text-white mb-2" id="confirmTitle">確認</h3>
                    <p class="text-sm text-slate-300" id="confirmMessage">確定要執行此操作嗎？</p>
                </div>
                <div class="bg-slate-900 px-4 py-3 sm:px-6 flex flex-row gap-3">
                    <button type="button" id="confirmBtn" class="flex-1 inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-aion-event text-base font-medium text-slate-900 hover:bg-pink-400 focus:outline-none sm:text-sm font-bold">確定</button>
                    <button type="button" onclick="closeConfirmModal()" class="flex-1 inline-flex justify-center rounded-md border border-slate-600 shadow-sm px-4 py-2 bg-slate-800 text-base font-medium text-slate-300 hover:text-white hover:bg-slate-700 focus:outline-none sm:text-sm">取消</button>
                </div>
             </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 border-l-4 border-aion-event text-white px-6 py-4 rounded shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center">
        <i class="fa-solid fa-circle-info mr-3 text-aion-event"></i>
        <span id="toastMsg">Notification</span>
    </div>

    <!-- Firebase Logic Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // User Provided Config
        const firebaseConfig = {
          apiKey: "AIzaSyCFasj7ww7AnnQ2QYw0jyv79kJ4aFCf7QI",
          authDomain: "aion222.firebaseapp.com",
          projectId: "aion222",
          storageBucket: "aion222.firebasestorage.app",
          messagingSenderId: "988326833096",
          appId: "1:988326833096:web:6943b8c172c4c43b8eeefd",
          measurementId: "G-8R4VCLCYNC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'aion2_tracker_v1';

        let unsubscribeSnapshot = null;
        let currentRoom = localStorage.getItem('aion2_room_id') || '';
        let isFirstLoad = true; 

        window.initFirebase = async () => {
             // For personal Firebase projects, make sure Anonymous Auth is enabled in the Firebase Console
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                if(window.showToast) window.showToast("Firebase 連線錯誤: 請檢查後台是否開啟匿名登入或網域白名單");
            }
        };

        window.joinRoom = (roomId) => {
            if (!auth.currentUser) {
                if(window.showToast) window.showToast("尚未連線至伺服器，請稍後再試");
                return; 
            }
            if (unsubscribeSnapshot) unsubscribeSnapshot(); 

            currentRoom = roomId;
            localStorage.setItem('aion2_room_id', roomId);
            isFirstLoad = true;
            
            if(window.updateConnectionUI) window.updateConnectionUI(true, roomId);

            // Path: artifacts/{appId}/public/data/boss_trackers/{roomId}
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'boss_trackers', roomId);
            
            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Room exists - Download cloud data
                    const data = docSnap.data();
                    if(window.updateLocalDataFromSync) window.updateLocalDataFromSync(data);
                    
                    if (isFirstLoad) {
                        if(window.showToast) window.showToast(`已加入房間 ${roomId}，同步雲端資料`);
                        isFirstLoad = false;
                    }
                } else {
                    // Room doesn't exist - Upload local data (Initialize room)
                    if (isFirstLoad) {
                        if(window.syncLocalToRemote) window.syncLocalToRemote(); 
                        if(window.showToast) window.showToast(`房間 ${roomId} 不存在，已建立並上傳本地資料`);
                        isFirstLoad = false;
                    }
                }
            }, (error) => {
                console.error("Sync error:", error);
                // Permission errors (like auth/admin-restricted) will trigger this
                if(window.showToast) window.showToast("同步錯誤: 權限不足或網域未授權");
                if(window.updateConnectionUI) window.updateConnectionUI(false, roomId);
            });
        };

        window.disconnectFromRoom = () => {
             if (unsubscribeSnapshot) unsubscribeSnapshot();
             unsubscribeSnapshot = null;
             currentRoom = '';
             localStorage.removeItem('aion2_room_id');
             if(window.updateConnectionUI) window.updateConnectionUI(false, '');
             if(window.showToast) window.showToast("已斷開連線，目前使用本地資料");
        };

        window.saveToRemote = async (data) => {
            if (!auth.currentUser || !currentRoom) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'boss_trackers', currentRoom);
                await setDoc(docRef, {
                    ...data,
                    lastUpdated: Date.now()
                });
            } catch (e) {
                console.error("Save error", e);
            }
        };

        // Initialize
        window.initFirebase();
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // If we had a room saved, rejoin it automatically
                if (currentRoom) {
                    window.joinRoom(currentRoom);
                }
            }
        });
    </script>

    <!-- Main Logic Script -->
    <script>
        // --- Sound Management ---
        let isSoundEnabled = false;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playAlertSound() {
            if (!isSoundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); 
            oscillator.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.5);
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.5);
        }

        function toggleSound() {
            isSoundEnabled = !isSoundEnabled;
            const btn = document.getElementById('soundToggleBtn');
            const icon = document.getElementById('soundIcon');
            if (isSoundEnabled) {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                btn.classList.replace('text-slate-400', 'text-aion-accent');
                btn.classList.replace('bg-slate-800', 'bg-slate-700');
                icon.classList.replace('fa-volume-xmark', 'fa-volume-high');
                playAlertSound(); 
                showToast('提示音效已開啟');
            } else {
                btn.classList.replace('text-aion-accent', 'text-slate-400');
                btn.classList.replace('bg-slate-700', 'bg-slate-800');
                icon.classList.replace('fa-volume-high', 'fa-volume-xmark');
                showToast('提示音效已關閉');
            }
            localStorage.setItem('aion2_sound_enabled', isSoundEnabled);
        }

        // --- Data Management ---
        let bosses = [];
        let autoKilledBosses = []; 
        let alertedBosses = []; 
        
        // Permanent Event Mode
        const isEventMode = true;
        let isFirebaseConnected = false;
        
        const regionConfig = {
            elyos: { label: '天族', color: 'text-sky-400', border: 'border-sky-500/30', bg: 'bg-sky-900/20' },
            asmodian: { label: '魔族', color: 'text-red-400', border: 'border-red-500/30', bg: 'bg-red-900/20' },
            abyss: { label: '深淵', color: 'text-purple-400', border: 'border-purple-500/30', bg: 'bg-purple-900/20' }
        };

        // --- Multiplayer Functions ---
        function openRoomModal() {
            const current = localStorage.getItem('aion2_room_id') || '';
            document.getElementById('roomNameInput').value = current;
            document.getElementById('roomModal').classList.remove('hidden');
        }

        function closeRoomModal() {
            document.getElementById('roomModal').classList.add('hidden');
        }

        function connectToRoom() {
            const roomName = document.getElementById('roomNameInput').value.trim();
            if(!roomName) {
                showToast('請輸入房間名稱');
                return;
            }
            if (window.joinRoom) {
                window.joinRoom(roomName);
                closeRoomModal();
                showToast('正在連線...');
            } else {
                showToast('系統初始化中，請稍後');
            }
        }
        
        function disconnectFromRoom() {
            if(window.disconnectFromRoom) {
                window.disconnectFromRoom();
            }
        }

        // Called by Firebase module
        window.updateConnectionUI = (connected, roomName) => {
            isFirebaseConnected = connected;
            const btn = document.getElementById('multiplayerBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const statusText = document.getElementById('roomStatusText');
            if (connected) {
                btn.classList.remove('bg-slate-700');
                btn.classList.add('bg-green-700', 'hover:bg-green-600', 'border-green-500');
                statusText.innerText = `已連線: ${roomName}`;
                disconnectBtn.classList.remove('hidden');
                disconnectBtn.classList.add('flex');
            } else {
                btn.classList.remove('bg-green-700', 'hover:bg-green-600', 'border-green-500');
                btn.classList.add('bg-slate-700');
                statusText.innerText = '多人連線';
                disconnectBtn.classList.add('hidden');
                disconnectBtn.classList.remove('flex');
            }
        };

        // Called by Firebase module on remote update
        window.updateLocalDataFromSync = (data) => {
            if (data.bosses) {
                bosses = data.bosses;
                bosses.forEach(b => {
                    // Although we don't use normalIntervalMin much, keep data integrity
                    if(b.normalIntervalMin) b.normalIntervalMin = Number(b.normalIntervalMin);
                    if(b.eventIntervalMin) b.eventIntervalMin = Number(b.eventIntervalMin);
                });
            }
            if (data.autoKilledBosses) {
                let parsed = data.autoKilledBosses;
                if (Array.isArray(parsed) && parsed.length > 0 && typeof parsed[0] === 'number') {
                    const now = Date.now();
                    parsed = parsed.map(id => ({ id: id, time: now }));
                }
                autoKilledBosses = parsed || [];
            }
            localStorage.setItem('aion2_boss_tracker', JSON.stringify(bosses));
            localStorage.setItem('aion2_auto_killed', JSON.stringify(autoKilledBosses));
            renderBosses();
            renderRecentActivity();
        };

        // Called by Firebase module if room is empty
        window.syncLocalToRemote = () => {
            if (window.saveToRemote) {
                window.saveToRemote({ bosses, autoKilledBosses });
            }
        };

        // Expose toast to window for module
        window.showToast = showToast;

        document.addEventListener('DOMContentLoaded', () => {
            loadBosses();
            const savedSound = localStorage.getItem('aion2_sound_enabled');
            if (savedSound === 'true') toggleSound();
            setInterval(updateTimers, 1000);
            updateClock();
            setInterval(updateClock, 1000);
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            
            const manualInput = document.getElementById('manualKillTime');
            manualInput.value = now.toISOString().slice(0, 16);
            
            // Add Enter key listener for manual time input
            manualInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    saveManualTime();
                }
            });
            
            // Recalculate spawns once on load to ensure everything is using event times
            recalculateAllSpawns();
        });

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('zh-TW', {hour12: false});
        }

        function loadBosses() {
            const storedData = localStorage.getItem('aion2_boss_tracker');
            const storedAutoKilled = localStorage.getItem('aion2_auto_killed');
            
            if (storedAutoKilled) {
                try {
                    let parsed = JSON.parse(storedAutoKilled);
                    if (Array.isArray(parsed) && parsed.length > 0 && typeof parsed[0] === 'number') {
                        const now = Date.now();
                        parsed = parsed.map(id => ({ id: id, time: now }));
                    }
                    autoKilledBosses = parsed || [];
                } catch(e) { autoKilledBosses = []; }
            }

            if (storedData === null) {
                loadDefaults(true);
                return;
            }
            if (storedData) {
                try {
                    bosses = JSON.parse(storedData);
                    bosses.forEach(b => {
                        if(b.normalIntervalMin) b.normalIntervalMin = Number(b.normalIntervalMin);
                        if(b.eventIntervalMin) b.eventIntervalMin = Number(b.eventIntervalMin);
                    });
                } catch (e) { bosses = []; }
            }
            renderBosses();
            renderRecentActivity();
        }

        function saveBosses() {
            // Save to LocalStorage
            localStorage.setItem('aion2_boss_tracker', JSON.stringify(bosses));
            localStorage.setItem('aion2_auto_killed', JSON.stringify(autoKilledBosses));
            
            // Save to Firebase if connected
            if (isFirebaseConnected && window.saveToRemote) {
                window.saveToRemote({ bosses, autoKilledBosses });
            }
            
            renderBosses();
            renderRecentActivity();
        }

        function loadDefaults(silent = false) {
             const now = Date.now();
            const defaults = [
                // --- 天族 (Elyos) ---
                { id: 1, name: '西側凱勒農', location: '坎塔斯溪谷', region: 'elyos', normalIntervalMin: 60, eventIntervalMin: 30, lastKill: 0, nextSpawn: 0 },
                { id: 2, name: '東側涅凱爾', location: '坎塔斯溪谷', region: 'elyos', normalIntervalMin: 60, eventIntervalMin: 30, lastKill: 0, nextSpawn: 0 },
                { id: 3, name: '腐朽的庫塔爾', location: '艾爾倫河沼澤', region: 'elyos', normalIntervalMin: 60, eventIntervalMin: 30, lastKill: 0, nextSpawn: 0 },
                { id: 4, name: '盛開的柯林', location: '艾爾倫河中游', region: 'elyos', normalIntervalMin: 120, eventIntervalMin: 60, lastKill: 0, nextSpawn: 0 },
                { id: 5, name: '護衛兵提甘特', location: '要塞廢墟', region: 'elyos', normalIntervalMin: 180, eventIntervalMin: 90, lastKill: 0, nextSpawn: 0 },
                { id: 6, name: '狂鬥士庫森', location: '要塞廢墟', region: 'elyos', normalIntervalMin: 240, eventIntervalMin: 120, lastKill: 0, nextSpawn: 0 },
                { id: 7, name: '祭司長加爾新', location: '要塞廢墟', region: 'elyos', normalIntervalMin: 240, eventIntervalMin: 120, lastKill: 0, nextSpawn: 0 },
                { id: 8, name: '血獠牙普寧', location: '托爾巴斯森林', region: 'elyos', normalIntervalMin: 360, eventIntervalMin: 180, lastKill: 0, nextSpawn: 0 },
                { id: 9, name: '憤怒的薩呂', location: '托爾巴斯森林', region: 'elyos', normalIntervalMin: 360, eventIntervalMin: 180, lastKill: 0, nextSpawn: 0 },
                { id: 10, name: '學者拉兀拉', location: '阿爾拉烏部落', region: 'elyos', normalIntervalMin: 240, eventIntervalMin: 120, lastKill: 0, nextSpawn: 0 },
                { id: 11, name: '追擊者塔兀羅', location: '阿爾拉烏部落', region: 'elyos', normalIntervalMin: 240, eventIntervalMin: 120, lastKill: 0, nextSpawn: 0 },
                { id: 12, name: '森林戰士烏剌姆', location: '阿爾拉烏部落', region: 'elyos', normalIntervalMin: 480, eventIntervalMin: 240, lastKill: 0, nextSpawn: 0 },
                { id: 13, name: '黑色觸手拉瓦', location: '阿爾塔米亞峽谷', region: 'elyos', normalIntervalMin: 480, eventIntervalMin: 240, lastKill: 0, nextSpawn: 0 },
                { id: 14, name: '叛教者雷拉', location: '阿爾塔米亞高原', region: 'elyos', normalIntervalMin: 360, eventIntervalMin: 180, lastKill: 0, nextSpawn: 0 },
                { id: 15, name: '百夫長戴米羅斯', location: '阿爾塔米亞高原', region: 'elyos', normalIntervalMin: 480, eventIntervalMin: 240, lastKill: 0, nextSpawn: 0 },
                { id: 16, name: '神聖的安薩斯', location: '阿爾塔米亞高原', region: 'elyos', normalIntervalMin: 720, eventIntervalMin: 360, lastKill: 0, nextSpawn: 0 },
                { id: 17, name: '收穫管理者莫夏夫', location: '德拉那栽培地', region: 'elyos', normalIntervalMin: 360, eventIntervalMin: 180, lastKill: 0, nextSpawn: 0 },
                { id: 18, name: '監視兵器克納許', location: '德拉那栽培地', region: 'elyos', normalIntervalMin: 480, eventIntervalMin: 240, lastKill: 0, nextSpawn: 0 },
                { id: 19, name: '研究官塞特蘭', location: '納希德軍團要塞', region: 'elyos', normalIntervalMin: 720, eventIntervalMin: 360, lastKill: 0, nextSpawn: 0 },
                { id: 20, name: '幻夢卡西亞', location: '幻影神庭院', region: 'elyos', normalIntervalMin: 720, eventIntervalMin: 360, lastKill: 0, nextSpawn: 0 },
                { id: 21, name: '沉默塔爾坦', location: '阿爾塔米亞高原南部', region: 'elyos', normalIntervalMin: 720, eventIntervalMin: 360, lastKill: 0, nextSpawn: 0 },
                { id: 22, name: '靈魂支配者卡沙帕', location: '阿爾塔米亞高原東部', region: 'elyos', normalIntervalMin: 720, eventIntervalMin: 360, lastKill: 0, nextSpawn: 0 },
                { id: 23, name: '軍團長拉格塔', location: '紅色森林', region: 'elyos', normalIntervalMin: 1440, eventIntervalMin: 720, lastKill: 0, nextSpawn: 0 },
                { id: 24, name: '永恆卡爾吐亞', location: '永恆之島', region: 'elyos', normalIntervalMin: 1440, eventIntervalMin: 720, lastKill: 0, nextSpawn: 0 },

                // --- 魔族 (Asmodian) ---
                { id: 25, name: '融化的達納樂', location: '德雷得奇安失事地', region: 'asmodian', normalIntervalMin: 60, eventIntervalMin: 30, lastKill: 0, nextSpawn: 0 },
                { id: 26, name: '黑色戰士阿埃德', location: '無名墓地', region: 'asmodian', normalIntervalMin: 60, eventIntervalMin: 30, lastKill: 0, nextSpawn: 0 },
                { id: 27, name: '忠實的拉吉特', location: '聖所監視哨所', region: 'asmodian', normalIntervalMin: 60, eventIntervalMin: 30, lastKill: 0, nextSpawn: 0 },
                { id: 28, name: '狂戰士瓦格', location: '聖所監視哨所', region: 'asmodian', normalIntervalMin: 120, eventIntervalMin: 60, lastKill: 0, nextSpawn: 0 },
                { id: 29, name: '血戰士蘭那爾', location: '瑪斯蘭森林', region: 'asmodian', normalIntervalMin: 180, eventIntervalMin: 90, lastKill: 0, nextSpawn: 0 },
                { id: 30, name: '捕食者加爾桑', location: '瑪斯蘭森林', region: 'asmodian', normalIntervalMin: 240, eventIntervalMin: 120, lastKill: 0, nextSpawn: 0 },
                { id: 31, name: '欺瞞者特里德', location: '烏爾通海姆', region: 'asmodian', normalIntervalMin: 240, eventIntervalMin: 120, lastKill: 0, nextSpawn: 0 },
                { id: 32, name: '藍色水波凱匹那', location: '淨化之森', region: 'asmodian', normalIntervalMin: 240, eventIntervalMin: 120, lastKill: 0, nextSpawn: 0 },
                { id: 33, name: '沉默塔爾坦', location: '淨化之森', region: 'asmodian', normalIntervalMin: 720, eventIntervalMin: 360, lastKill: 0, nextSpawn: 0 },
                { id: 34, name: '參謀官勒沙納', location: '德拉那克圖斯', region: 'asmodian', normalIntervalMin: 360, eventIntervalMin: 180, lastKill: 0, nextSpawn: 0 },
                { id: 35, name: '總監督官努塔', location: '德拉那克圖斯', region: 'asmodian', normalIntervalMin: 240, eventIntervalMin: 120, lastKill: 0, nextSpawn: 0 },
                { id: 36, name: '別動隊長令克斯', location: '巴斯斐爾特廢墟', region: 'asmodian', normalIntervalMin: 360, eventIntervalMin: 180, lastKill: 0, nextSpawn: 0 },
                { id: 37, name: '褻瀆者諾布魯德', location: '巴斯斐爾特廢墟', region: 'asmodian', normalIntervalMin: 480, eventIntervalMin: 240, lastKill: 0, nextSpawn: 0 },
                { id: 38, name: '亡魂執政官亞克席歐斯', location: '巴斯斐爾特廢墟', region: 'asmodian', normalIntervalMin: 480, eventIntervalMin: 240, lastKill: 0, nextSpawn: 0 },
                { id: 39, name: '中毒的哈迪倫', location: '法夫奈特埋藏地', region: 'asmodian', normalIntervalMin: 360, eventIntervalMin: 180, lastKill: 0, nextSpawn: 0 },
                { id: 40, name: '靈魂支配者卡沙帕', location: '法夫奈特埋藏地', region: 'asmodian', normalIntervalMin: 720, eventIntervalMin: 360, lastKill: 0, nextSpawn: 0 },
                { id: 41, name: '處刑者巴爾西恩', location: '葛利巴德峽谷西部', region: 'asmodian', normalIntervalMin: 480, eventIntervalMin: 240, lastKill: 0, nextSpawn: 0 },
                { id: 42, name: '德拉坎部隊兵器古魯塔', location: '葛利巴德峽谷東部', region: 'asmodian', normalIntervalMin: 720, eventIntervalMin: 360, lastKill: 0, nextSpawn: 0 },
                { id: 43, name: '百戰老將舒札坎', location: '黑爪部落', region: 'asmodian', normalIntervalMin: 360, eventIntervalMin: 180, lastKill: 0, nextSpawn: 0 },
                { id: 44, name: '祕傳卡魯卡', location: '黑爪部落', region: 'asmodian', normalIntervalMin: 480, eventIntervalMin: 240, lastKill: 0, nextSpawn: 0 },
                { id: 45, name: '黑闇比修貝達', location: '拉格塔要塞', region: 'asmodian', normalIntervalMin: 720, eventIntervalMin: 360, lastKill: 0, nextSpawn: 0 },
                { id: 46, name: '軍團長拉格塔', location: '拉格塔要塞', region: 'asmodian', normalIntervalMin: 1440, eventIntervalMin: 720, lastKill: 0, nextSpawn: 0 },
                { id: 47, name: '敏銳的敘拉克', location: '因派圖西姆廣場', region: 'asmodian', normalIntervalMin: 720, eventIntervalMin: 360, lastKill: 0, nextSpawn: 0 },
                { id: 48, name: '不滅卡爾吐亞', location: '不滅之島', region: 'asmodian', normalIntervalMin: 1440, eventIntervalMin: 720, lastKill: 0, nextSpawn: 0 },

                // --- 深淵 (Abyss) ---
                { id: 49, name: '監視者卡伊拉', location: '艾雷修藍塔下層', region: 'abyss', normalIntervalMin: 60, eventIntervalMin: 60, lastKill: 0, nextSpawn: 0 },
                { id: 50, name: '精靈王阿格羅', location: '希埃爾右翼', region: 'abyss', normalIntervalMin: 1440, eventIntervalMin: 720, lastKill: 0, nextSpawn: 0 },
                { 
                    id: 51, 
                    name: '守護神將納赫瑪', 
                    location: '艾雷修藍塔之根', 
                    region: 'abyss', 
                    fixedSchedule: true, 
                    // 0=Sun, 6=Sat. hour in 24h format.
                    normalSchedule: [{day: 0, hour: 20, min: 0}], 
                    eventSchedule: [{day: 6, hour: 20, min: 0}, {day: 0, hour: 20, min: 0}],
                    lastKill: 0, 
                    nextSpawn: 0 
                },
            ];
            
            defaults.forEach(b => {
                if (b.fixedSchedule) {
                    b.nextSpawn = calculateNextFixedSpawn(b);
                }
            });

            bosses = defaults;
            saveBosses();
            if (!silent) showToast('已載入 完整BOSS (含深淵) 資料');
        }

        // --- Core Logic & Event Handlers ---
        
        // Always force event mode calculation
        function recalculateAllSpawns() {
            const now = Date.now();
            bosses.forEach(boss => {
                if (boss.fixedSchedule) {
                     boss.nextSpawn = calculateNextFixedSpawn(boss);
                } else if (boss.lastKill > 0) {
                    // Force usage of eventIntervalMin
                    const interval = boss.eventIntervalMin || boss.normalIntervalMin;
                    const newNextSpawn = boss.lastKill + (interval * 60000);
                    boss.nextSpawn = newNextSpawn;
                }
            });
            alertedBosses = [];
            saveBosses();
        }

        function calculateNextFixedSpawn(boss) {
            if (!boss.fixedSchedule) return 0;
            // Always use event schedule if available
            const schedules = boss.eventSchedule || boss.normalSchedule;
            if (!schedules || schedules.length === 0) return 0;

            const now = new Date();
            let nextDate = null;

            for (let sch of schedules) {
                let d = new Date(now);
                d.setHours(sch.hour, sch.min, 0, 0);
                let dayDiff = sch.day - now.getDay();
                if (dayDiff < 0) dayDiff += 7;
                if (dayDiff === 0 && d <= now) dayDiff = 7;
                d.setDate(now.getDate() + dayDiff);
                
                if (!nextDate || d < nextDate) nextDate = d;
            }
            return nextDate ? nextDate.getTime() : 0;
        }

        function getActiveFilters() {
            const checkboxes = document.querySelectorAll('.filter-checkbox');
            const active = [];
            checkboxes.forEach(cb => {
                if (cb.checked) active.push(cb.value);
            });
            return active;
        }

        // --- Render Functions ---
        function renderRecentActivity() {
            const panel = document.getElementById('recentActivityPanel');
            const list = document.getElementById('recentActivityList');
            list.innerHTML = '';
            
            const validEntries = autoKilledBosses.filter(entry => bosses.find(b => b.id === entry.id));
            if(validEntries.length !== autoKilledBosses.length) {
                autoKilledBosses = validEntries;
            }

            const sortedEntries = [...autoKilledBosses].sort((a, b) => b.time - a.time).slice(0, 10);
            
            if (sortedEntries.length === 0) {
                panel.classList.add('hidden');
                return;
            }
            
            panel.classList.remove('hidden');
            
            sortedEntries.forEach(entry => {
                const boss = bosses.find(b => b.id === entry.id);
                if (!boss) return;

                const row = document.createElement('div');
                row.className = 'px-6 py-3 flex items-center justify-between bg-slate-800/50';
                
                const minsAgo = Math.floor((Date.now() - entry.time) / 60000);
                const timeText = minsAgo < 1 ? '剛剛' : `${minsAgo} 分鐘前`;

                row.innerHTML = `
                    <div class="flex-1">
                        <div class="text-white font-bold flex items-center">
                            <span class="w-2 h-2 rounded-full bg-yellow-500 mr-2 animate-pulse"></span>
                            ${boss.name} <span class="ml-2 text-xs text-slate-500 font-normal">(${timeText})</span>
                        </div>
                        <div class="text-xs text-slate-400">系統自動判定擊殺 - 請確認狀態</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="confirmAutoKill(${boss.id})" class="px-3 py-1 bg-green-600 hover:bg-green-500 text-white text-xs rounded transition flex items-center">
                            <i class="fa-solid fa-check mr-1"></i> 補刀
                        </button>
                        <button onclick="dismissAutoKill(${boss.id})" class="px-3 py-1 bg-slate-600 hover:bg-slate-500 text-white text-xs rounded transition flex items-center">
                            <i class="fa-solid fa-xmark mr-1"></i> 忽略
                        </button>
                    </div>
                `;
                list.appendChild(row);
            });
        }

        function confirmAutoKill(id) {
            const boss = bosses.find(b => b.id === id);
            if (boss) {
                const now = Date.now();
                // Force event interval
                const interval = boss.eventIntervalMin || boss.normalIntervalMin;
                const safeInterval = interval > 0 ? interval : 60;
                boss.lastKill = now;
                boss.nextSpawn = now + (safeInterval * 60 * 1000);
            }
            autoKilledBosses = autoKilledBosses.filter(entry => entry.id !== id);
            saveBosses();
            showToast('已更新擊殺時間為現在');
        }

        function dismissAutoKill(id) {
            autoKilledBosses = autoKilledBosses.filter(entry => entry.id !== id);
            saveBosses();
            showToast('已忽略通知');
        }

        function renderBosses() {
            const listContainer = document.getElementById('bossList');
            const emptyState = document.getElementById('emptyState');
            const activeFilters = getActiveFilters();
            listContainer.innerHTML = '';

            const filteredBosses = bosses.filter(b => activeFilters.includes(b.region || 'abyss'));

            if (filteredBosses.length === 0) {
                document.querySelector('.bg-slate-800.rounded-xl').classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            document.querySelector('.bg-slate-800.rounded-xl').classList.remove('hidden');
            emptyState.classList.add('hidden');

            const now = Date.now();
            filteredBosses.sort((a, b) => {
                const aSpawned = a.nextSpawn <= now;
                const bSpawned = b.nextSpawn <= now;
                if (aSpawned && !bSpawned) return -1;
                if (!aSpawned && bSpawned) return 1;
                return a.nextSpawn - b.nextSpawn;
            });

            filteredBosses.forEach(boss => {
                const isSpawned = boss.nextSpawn <= now;
                const regionStyle = regionConfig[boss.region] || regionConfig['abyss'];
                
                let intervalText = '';
                if (boss.fixedSchedule) {
                    intervalText = '固定重生';
                } else {
                    // Always show event interval
                    const currentInterval = boss.eventIntervalMin || boss.normalIntervalMin;
                    intervalText = `${formatInterval(currentInterval)}`;
                }
                
                const row = document.createElement('div');
                row.className = `boss-row grid grid-cols-12 gap-4 px-6 py-2 items-center ${isSpawned ? 'spawned' : 'cooling'}`;
                row.id = `row-${boss.id}`;

                row.innerHTML = `
                    <div class="col-span-4 lg:col-span-3 flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2">
                        <div class="font-bold text-white text-base truncate" title="${boss.name}">
                            ${boss.name}
                            <span class="text-xs text-slate-400 font-normal ml-1">[${boss.location || '未知區域'}]</span>
                        </div>
                    </div>
                    <div class="col-span-2 text-center hidden md:block">
                        <span class="text-xs font-bold px-2 py-1 rounded border ${regionStyle.bg} ${regionStyle.color} ${regionStyle.border}">
                            ${regionStyle.label}
                        </span>
                    </div>
                    <div class="col-span-2 text-center text-slate-400 text-sm hidden md:block">
                        <i class="fa-solid fa-hourglass-half mr-1 text-slate-600"></i>${intervalText}
                    </div>
                    <div class="col-span-6 md:col-span-3 text-center flex flex-col md:flex-row items-center justify-center gap-2">
                        <div class="flex-1">
                             <div class="font-mono font-bold text-lg md:text-xl timer-display ${isSpawned ? 'text-aion-success' : 'text-aion-event'}" id="timer-${boss.id}">
                                ${isSpawned ? '已重生' : '--:--:--'}
                            </div>
                            <div class="text-xs text-slate-500 mt-1 hidden sm:block" id="next-time-${boss.id}">
                                ${isSpawned ? '請盡快擊殺' : `預計: ${formatTimeStr(boss.nextSpawn)}`}
                            </div>
                        </div>
                        <div class="text-xs text-slate-600 font-mono hidden md:block" title="上次擊殺時間">
                            <i class="fa-solid fa-clock-rotate-left mr-1"></i>
                            <span id="last-kill-${boss.id}">${boss.lastKill > 0 ? formatTimeStr(boss.lastKill) : '--:--'}</span>
                        </div>
                    </div>
                    <div class="col-span-2 lg:col-span-2 flex justify-end gap-2">
                        <button onclick="openTimeEdit(${boss.id})" class="p-2 text-slate-400 hover:text-white bg-slate-700/50 hover:bg-slate-700 rounded transition" title="修改擊殺時間">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                        <button onclick="recordKill(${boss.id})" class="hidden sm:inline-flex items-center px-3 py-2 text-sm font-medium rounded transition ${isSpawned ? 'bg-aion-success text-white hover:bg-green-600 shadow-[0_0_10px_rgba(34,197,94,0.4)]' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}">
                            ${boss.fixedSchedule ? '<i class="fa-solid fa-rotate-right"></i>' : (isSpawned ? '<i class="fa-solid fa-skull mr-2"></i> 擊殺' : '<i class="fa-solid fa-arrow-rotate-right"></i>')}
                        </button>
                        <button onclick="recordKill(${boss.id})" class="sm:hidden p-2 rounded transition ${isSpawned ? 'bg-aion-success text-white shadow-[0_0_10px_rgba(34,197,94,0.4)]' : 'bg-slate-700 text-slate-300'}">
                            <i class="fa-solid fa-skull"></i>
                        </button>
                        <div class="relative">
                            <button onclick="toggleMenu(${boss.id})" class="p-2 text-slate-500 hover:text-white transition">
                                <i class="fa-solid fa-ellipsis-vertical"></i>
                            </button>
                            <div id="menu-${boss.id}" class="hidden absolute right-0 mt-2 w-32 bg-slate-800 rounded-md shadow-xl z-20 border border-slate-600 overflow-hidden">
                                <button onclick="editBoss(${boss.id})" class="block w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-700">編輯資料</button>
                                <button onclick="deleteBoss(${boss.id})" class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-slate-700">刪除 Boss</button>
                            </div>
                        </div>
                    </div>
                `;
                listContainer.appendChild(row);
            });
        }

        // --- Helper & Timer Logic ---
        function updateTimers() {
            const now = Date.now();
            let autoKillChanged = false;

            const initialLen = autoKilledBosses.length;
            autoKilledBosses = autoKilledBosses.filter(entry => (now - entry.time) < 600000);
            if (autoKilledBosses.length !== initialLen) autoKillChanged = true;
            
            bosses.forEach(boss => {
                const timerEl = document.getElementById(`timer-${boss.id}`);
                const nextTimeEl = document.getElementById(`next-time-${boss.id}`);
                const lastKillEl = document.getElementById(`last-kill-${boss.id}`);
                
                if (!timerEl) return;

                // Update last kill time display dynamically if needed (though it's static until action)
                if (lastKillEl && boss.lastKill > 0) {
                     lastKillEl.innerText = formatTimeStr(boss.lastKill);
                }

                if (boss.nextSpawn <= now && !boss.fixedSchedule && boss.lastKill > 0) { 
                    const timeSinceSpawn = now - boss.nextSpawn;
                    if (timeSinceSpawn > 15000) {
                        // Force event interval
                        const interval = boss.eventIntervalMin || boss.normalIntervalMin;
                        const safeInterval = interval > 0 ? interval : 60;
                        boss.lastKill = boss.nextSpawn; 
                        boss.nextSpawn = boss.lastKill + (safeInterval * 60 * 1000);
                        if (!autoKilledBosses.some(entry => entry.id === boss.id)) {
                            autoKilledBosses.push({ id: boss.id, time: now });
                            autoKillChanged = true;
                        }
                        alertedBosses = alertedBosses.filter(id => id !== boss.id);
                        saveBosses();
                        showToast(`已自動判定 ${boss.name} 擊殺 (逾時)`);
                        return; 
                    }
                }

                const timeDiff = boss.nextSpawn - now;
                if (!boss.fixedSchedule && boss.nextSpawn > now && timeDiff <= 180000 && timeDiff > 0) {
                    if (!alertedBosses.includes(boss.id)) {
                        playAlertSound();
                        alertedBosses.push(boss.id);
                        const row = document.getElementById(`row-${boss.id}`);
                        if(row) row.classList.add('alert');
                        showToast(`${boss.name} 即將重生 (3分鐘)`);
                    }
                } else if (boss.nextSpawn <= now || timeDiff > 185000) {
                    if (alertedBosses.includes(boss.id)) {
                        alertedBosses = alertedBosses.filter(id => id !== boss.id);
                        const row = document.getElementById(`row-${boss.id}`);
                        if(row) row.classList.remove('alert');
                    }
                }

                const updateStatus = (spawned) => {
                    const row = timerEl.closest('.boss-row');
                    if(spawned) {
                        timerEl.innerText = '已重生';
                        timerEl.className = 'font-mono font-bold text-lg md:text-xl timer-display text-aion-success status-badge';
                        if(nextTimeEl) nextTimeEl.innerText = '請盡快擊殺';
                        if(row) {
                            row.classList.add('spawned');
                            row.classList.remove('cooling');
                            row.classList.remove('alert');
                        }
                    } else {
                        const diff = boss.nextSpawn - now;
                        const hours = Math.floor(diff / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                        const timeStr = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
                        timerEl.innerText = timeStr;
                        timerEl.className = `font-mono font-bold text-lg md:text-xl timer-display text-aion-event`;
                        if(nextTimeEl) nextTimeEl.innerText = `預計: ${formatTimeStr(boss.nextSpawn)}`;
                        if(row) {
                            row.classList.remove('spawned');
                            row.classList.add('cooling');
                        }
                    }
                };

                if (boss.fixedSchedule) {
                     updateStatus(now >= boss.nextSpawn);
                } else {
                     updateStatus(boss.nextSpawn <= now);
                }
            });

            if (autoKillChanged) saveBosses();
        }

        function recordKill(id) {
            const boss = bosses.find(b => b.id === id);
            if (!boss) return;

            if (boss.fixedSchedule) {
                 boss.nextSpawn = calculateNextFixedSpawn(boss);
                 saveBosses();
                 showToast(`已重置 ${boss.name} 至下個時段`);
                 return;
            }

            const now = Date.now();
            // Force event interval
            const interval = boss.eventIntervalMin || boss.normalIntervalMin;
            const safeInterval = interval > 0 ? interval : 60;

            boss.lastKill = now;
            boss.nextSpawn = now + (safeInterval * 60 * 1000);
            
            autoKilledBosses = autoKilledBosses.filter(entry => entry.id !== id);
            alertedBosses = alertedBosses.filter(bid => bid !== id);
            
            const row = document.getElementById(`row-${id}`);
            if(row) row.classList.remove('alert');

            saveBosses();
            showToast(`已記錄 ${boss.name} 擊殺！`);
        }

        // --- Manual Time Edit ---
        function openTimeEdit(id) {
            const boss = bosses.find(b => b.id === id);
            if (!boss) return;
            document.getElementById('editTimeBossId').value = id;
            document.getElementById('manualKillTime').value = '';
            document.getElementById('timeEditModal').classList.remove('hidden');
            setTimeout(() => { document.getElementById('manualKillTime').focus(); }, 100);
        }

        function closeTimeEditModal() {
            document.getElementById('timeEditModal').classList.add('hidden');
        }

        function saveManualTime() {
            const id = parseInt(document.getElementById('editTimeBossId').value);
            const inputVal = document.getElementById('manualKillTime').value.trim();
            if (!inputVal) { showToast("請輸入時間"); return; }
            
            const cleanVal = inputVal.replace(/:/g, '');
            let hh, mm, ss = 0;
            if (cleanVal.length === 4) {
                hh = parseInt(cleanVal.substring(0, 2));
                mm = parseInt(cleanVal.substring(2, 4));
            } else if (cleanVal.length === 6) {
                hh = parseInt(cleanVal.substring(0, 2));
                mm = parseInt(cleanVal.substring(2, 4));
                ss = parseInt(cleanVal.substring(4, 6));
            } else {
                showToast("格式錯誤。請輸入 1430 或 143010"); return;
            }
            
            if (isNaN(hh) || isNaN(mm) || isNaN(ss) || hh > 23 || mm > 59 || ss > 59) {
                showToast("時間不合法"); return;
            }
            
            const now = new Date();
            let killTime = new Date(now);
            killTime.setHours(hh, mm, ss, 0);
            if (killTime > now) killTime.setDate(killTime.getDate() - 1);
            
            const boss = bosses.find(b => b.id === id);
            if (!boss) return;
            
            // Force event interval
            const interval = boss.eventIntervalMin || boss.normalIntervalMin;
            const safeInterval = interval > 0 ? interval : 60;
            
            boss.lastKill = killTime.getTime();
            boss.nextSpawn = boss.lastKill + (safeInterval * 60 * 1000);
            autoKilledBosses = autoKilledBosses.filter(entry => entry.id !== id);
            alertedBosses = alertedBosses.filter(bid => bid !== id);
            
            const row = document.getElementById(`row-${id}`);
            if(row) row.classList.remove('alert');
            
            saveBosses();
            closeTimeEditModal();
            showToast(`已修正 ${boss.name} 時間為 ${pad(hh)}:${pad(mm)}:${pad(ss)}`);
        }

        // --- Export/Import ---
        function exportData() {
            const dataToExport = { bosses: bosses, autoKilledBosses: autoKilledBosses, version: "1.0", timestamp: Date.now() };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToExport));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "aion2_boss_data.json");
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast('資料匯出成功');
        }

        function importData(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!importedData.bosses || !Array.isArray(importedData.bosses)) throw new Error("無效的資料格式");
                    if (!confirm("確定要匯入此檔案嗎？這將會覆蓋您目前的資料。")) {
                        inputElement.value = ''; return;
                    }
                    bosses = importedData.bosses;
                    if(importedData.autoKilledBosses) {
                        autoKilledBosses = importedData.autoKilledBosses;
                        if(autoKilledBosses.length > 0 && typeof autoKilledBosses[0] === 'number') {
                             const now = Date.now();
                             autoKilledBosses = autoKilledBosses.map(id => ({ id: id, time: now }));
                        }
                    } else { autoKilledBosses = []; }
                    saveBosses();
                    showToast('資料匯入成功');
                } catch (err) { console.error(err); showToast('匯入失敗：檔案格式錯誤'); }
                inputElement.value = '';
            };
            reader.readAsText(file);
        }

        // --- Shared ---
        let confirmCallback = null;
        function showConfirm(title, msg, callback) {
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMessage').innerText = msg;
            document.getElementById('confirmModal').classList.remove('hidden');
            confirmCallback = callback;
        }
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            confirmCallback = null;
        }
        document.getElementById('confirmBtn').addEventListener('click', () => { if (confirmCallback) confirmCallback(); closeConfirmModal(); });

        let isEditing = false;
        let editingId = null;
        function openModal(editMode = false, id = null) {
            const modal = document.getElementById('bossModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('bossForm');
            modal.classList.remove('hidden');
            isEditing = editMode;
            editingId = id;
            if (editMode) {
                const boss = bosses.find(b => b.id === id);
                title.innerText = '編輯 Boss';
                document.getElementById('bossName').value = boss.name;
                document.getElementById('bossLocation').value = boss.location;
                const regionVal = boss.region || 'abyss';
                const radio = document.querySelector(`input[name="region"][value="${regionVal}"]`);
                if(radio) radio.checked = true;
                
                // Only load Event times
                const eHours = Math.floor((boss.eventIntervalMin || boss.normalIntervalMin) / 60);
                const eMins = (boss.eventIntervalMin || boss.normalIntervalMin) % 60;
                document.getElementById('eventHours').value = eHours;
                document.getElementById('eventMinutes').value = eMins;
            } else {
                title.innerText = '新增 Boss';
                form.reset();
                document.querySelector('input[name="region"][value="abyss"]').checked = true;
            }
        }
        function closeModal() {
            document.getElementById('bossModal').classList.add('hidden');
            document.querySelectorAll('[id^="menu-"]').forEach(el => el.classList.add('hidden')); 
        }
        function handleFormSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('bossName').value;
            const loc = document.getElementById('bossLocation').value;
            const region = document.querySelector('input[name="region"]:checked').value;
            
            // Only read Event inputs
            const eh = parseInt(document.getElementById('eventHours').value) || 0;
            const em = parseInt(document.getElementById('eventMinutes').value) || 0;
            const eventTotal = (eh * 60) + em;
            
            if (eventTotal <= 0) { showToast("錯誤：重生間隔必須大於 0"); return; }
            
            // Mirror logic: Set normalIntervalMin to same as event for data consistency
            const normalTotal = eventTotal; 

            if (isEditing) {
                const boss = bosses.find(b => b.id === editingId);
                boss.name = name;
                boss.location = loc;
                boss.region = region;
                boss.normalIntervalMin = normalTotal;
                boss.eventIntervalMin = eventTotal;
            } else {
                bosses.push({
                    id: Date.now(),
                    name: name,
                    location: loc,
                    region: region,
                    normalIntervalMin: normalTotal,
                    eventIntervalMin: eventTotal,
                    lastKill: 0,
                    nextSpawn: 0
                });
            }
            saveBosses();
            closeModal();
            showToast(isEditing ? 'Boss 資料已更新' : '已新增 Boss');
        }
        function editBoss(id) { openModal(true, id); }
        function deleteBoss(id) {
            showConfirm('刪除確認', '確定要刪除這個 Boss 嗎？', () => {
                bosses = bosses.filter(b => b.id !== id);
                saveBosses();
                showToast('已刪除');
            });
        }
        function toggleMenu(id) {
            const menu = document.getElementById(`menu-${id}`);
            const isHidden = menu.classList.contains('hidden');
            document.querySelectorAll('[id^="menu-"]').forEach(el => el.classList.add('hidden'));
            if (isHidden) menu.classList.remove('hidden');
        }
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.relative')) { document.querySelectorAll('[id^="menu-"]').forEach(el => el.classList.add('hidden')); }
        });
        function formatInterval(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            if (h > 0 && m > 0) return `${h}h ${m}m`;
            if (h > 0) return `${h}h`;
            return `${m}m`;
        }
        function pad(num) { return num.toString().padStart(2, '0'); }
        function formatTimeStr(timestamp) {
            const d = new Date(timestamp);
            return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }
        function showToast(msg) {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toastMsg');
            msgEl.innerText = msg;
            toast.classList.remove('opacity-0', 'translate-y-20');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-20'); }, 3000);
        }
    </script>
</body>
</html>
