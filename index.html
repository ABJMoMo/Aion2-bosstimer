<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AION 2ï½œBOSS å€’æ•¸è¨ˆæ™‚å™¨ï¼ˆå¤šäººå…±ç”¨ï¼‰</title>

  <style>
    :root{
      --bg:#0b0f17; --panel:#121a2a; --text:#e8eefc; --muted:#9fb0d0; --line:rgba(255,255,255,.10);
      --accent:#7aa7ff; --danger:#ff6b6b; --good:#49d17d; --warn:#ffd166;
      --shadow: 0 12px 30px rgba(0,0,0,.35); --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:
        radial-gradient(1200px 600px at 10% 0%, rgba(122,167,255,.16), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(73,209,125,.12), transparent 55%),
        var(--bg);
      color:var(--text); font-family:var(--sans);
    }

    /* âœ… topbar æ”¹ fixed å¾Œï¼Œéœ€è¦è£œä¸Š wrap çš„ padding-topï¼ˆé¿å…è¢«è“‹ä½ï¼‰ */
    .wrap{max-width:1180px;margin:24px auto;padding:160px 16px 40px}

    /* âœ… æœ€ä¸Šæ–¹è¨­å®šåˆ—å›ºå®šä¸éš¨æ»¾è¼ªç§»å‹• */
    .topbar{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      padding:16px;

      background:linear-gradient(180deg, rgba(255,255,255,.06), transparent), var(--panel);
      border-bottom:1px solid var(--line);
      box-shadow:var(--shadow);

      position:fixed;
      top:0; left:0; right:0;
      z-index:1000;
      backdrop-filter: blur(10px);

      border-radius:0;
    }

    .title{display:flex; flex-direction:column; gap:6px; min-width:260px}
    .title h1{margin:0; font-size:18px; letter-spacing:.2px}
    .title .sub{color:var(--muted); font-size:12px; line-height:1.35}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .btn,.chip,select,input[type="number"],input[type="range"],input[type="text"]{
      border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.06);
      color:var(--text); padding:9px 12px; font-size:13px;
    }
    .btn{cursor:pointer; transition:transform .06s ease, border-color .2s}
    .btn:hover{border-color:rgba(122,167,255,.55)} .btn:active{transform:translateY(1px)}
    .btn.danger{border-color:rgba(255,107,107,.35)} .btn.danger:hover{border-color:rgba(255,107,107,.65)}
    .btn.primary{border-color:rgba(122,167,255,.35)} .btn.primary:hover{border-color:rgba(122,167,255,.70)}
    .btn.good{border-color:rgba(73,209,125,.35)} .btn.good:hover{border-color:rgba(73,209,125,.70)}
    .grid{display:grid; grid-template-columns: 1.25fr .75fr; gap:14px; margin-top:14px;}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), transparent), var(--panel);
      border:1px solid var(--line); border-radius:var(--radius);
      box-shadow:var(--shadow); overflow:hidden;
    }
    .tabs{display:flex; gap:8px; padding:10px 12px; border-bottom:1px solid var(--line); flex-wrap:wrap}
    .tab{
      padding:7px 10px; border-radius:999px; border:1px solid var(--line);
      background:rgba(255,255,255,.06); cursor:pointer; font-size:13px;
    }
    .tab.active{border-color:rgba(122,167,255,.7); box-shadow:0 0 0 3px rgba(122,167,255,.12) inset}
    .body{padding:14px 16px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .kpi .chip{display:flex; align-items:center; gap:8px}
    .hint{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.45}
    input[type="range"]{accent-color: var(--accent)}
    .list{display:flex; flex-direction:column; gap:10px; margin-top:14px}
    .item{
      padding:12px; border:1px solid var(--line); border-radius:14px; background:rgba(255,255,255,.04);
      display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center;
    }
    .meta{display:flex; flex-direction:column; gap:6px; min-width:0}
    .nameRow{display:flex; gap:8px; align-items:center; min-width:0; flex-wrap:wrap}
    .name{font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:520px}
    .star{cursor:pointer; font-size:16px; line-height:1; opacity:.9}
    .star.off{opacity:.35}
    .tiny{font-size:12px; color:var(--muted)}
    .countdown{font-family:var(--mono); font-size:14px}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line);
      color:var(--muted);
    }
    .badge.good{color:var(--good); border-color:rgba(73,209,125,.25)}
    .badge.warn{color:var(--warn); border-color:rgba(255,209,102,.25)}
    .badge.danger{color:var(--danger); border-color:rgba(255,107,107,.25)}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .actions .btn{padding:8px 10px}
    .favitem{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px; border:1px dashed var(--line); border-radius:14px;
      margin-top:10px;
    }
    .favitem .left{display:flex; flex-direction:column; gap:4px; min-width:0}
    .mono{font-family:var(--mono)}
    .muted{color:var(--muted)}
    .roombar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .roombar input{width:180px}
    .statusDot{display:inline-block;width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.25);border:1px solid var(--line);margin-right:6px}
    .statusDot.ok{background:rgba(73,209,125,.8)}
    .statusDot.bad{background:rgba(255,107,107,.8)}
    select{appearance:auto}

    /* ===== å­—é«”å¤§å°ï¼ˆæœ¬æ©Ÿ UI åå¥½ï¼‰ ===== */
    :root{ --fontScale: 1; }
    html{ font-size: calc(16px * var(--fontScale)); }
    html[data-font="sm"]{ --fontScale: 0.92; }
    html[data-font="md"]{ --fontScale: 1; }
    html[data-font="lg"]{ --fontScale: 1.10; }

    /* ===== Modal å…±ç”¨ ===== */
    .modalMask{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:9999;
    }
    .modal{
      width:min(560px, 96vw);
      background:linear-gradient(180deg, rgba(255,255,255,.06), transparent), var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px; border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .modalHead b{font-size:14px}
    .modalBody{padding:14px}
    .modalRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .modalRow .chip{background:rgba(255,255,255,.04)}
    .modalFoot{
      padding:12px 14px; border-top:1px solid var(--line);
      display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;
    }

    .kv{display:grid; grid-template-columns: 120px 1fr; gap:8px 12px; margin-top:10px}
    .kv .k{color:var(--muted); font-size:12px}
    .kv .v{font-size:12px}
    .hr{height:1px;background:var(--line); margin:12px 0}

    /* ===== UI Lockï¼ˆåŒæ­¥ä¸­é–å®šï¼‰ ===== */
    body.locked .controls,
    body.locked .grid,
    body.locked .tabs{
      pointer-events:none;
      opacity:.55;
      filter:saturate(.8);
    }
    .lockBanner{
      display:none;
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
    }
    body.locked .lockBanner{display:block}

    /* ä¿®æ­£ä¸‹æ‹‰é¸å–®åœ¨æš—è‰²èƒŒæ™¯çš„é¡¯ç¤º */
    select {
      background-color: #121a2a;
      color: #e8eefc;
      border: 1px solid rgba(255,255,255,.2);
    }
    select option {
      background-color: #121a2a;
      color: #e8eefc;
    }
    select option:checked {
      background-color: #1f2a44;
      color: #ffffff;
    }
    select option:hover {
      background-color: #24335c;
      color: #ffffff;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">
      <h1>AION 2ï½œBOSS å€’æ•¸è¨ˆæ™‚å™¨ï¼ˆå¤šäººå…±ç”¨ï¼‰</h1>
      <div class="sub">
        åŒä¸€å€‹ Room ID çš„äººæœƒåŒæ­¥çœ‹åˆ°åŒä¸€ä»½å€’æ•¸è³‡æ–™ï¼ˆæ“Šæ®º/ç·¨è¼¯/æ–°å¢æœƒå³æ™‚åŒæ­¥ï¼‰ã€‚<br>
        â€» ã€Œå­—é«”/åªçœ‹æ”¶è—/æç¤ºéŸ³é¸å–®/æœ€è¿‘é‡ç”Ÿç¯©é¸ã€ç‚ºæœ¬æ©Ÿåå¥½ï¼Œä¸æœƒåŒæ­¥åˆ°æˆ¿é–“ã€‚
      </div>

      <div class="roombar" style="margin-top:8px">
        <span class="chip">
          <span class="statusDot" id="dot"></span>
          <span id="cloudStatus">æœªé€£ç·š</span>
        </span>

        <span class="chip" title="æˆ¿ä¸»=å»ºç«‹æˆ¿é–“è€…ï¼ˆmeta.hostIdï¼‰">
          èº«åˆ†ï¼š<b id="roleLabel" class="mono">â€”</b>
        </span>

        <span class="chip" title="ä½ æ˜¯ç¬¬å¹¾å€‹åŠ å…¥æˆ¿é–“çš„äººï¼ˆmeta.joinSeqï¼‰">
          åŠ å…¥åºï¼š<b id="joinIndexLabel" class="mono">â€”</b>
        </span>

        <span class="chip" title="25 ç§’å…§æœ‰å¿ƒè·³è¦–ç‚ºåœ¨ç·šï¼ˆpresenceï¼‰">
          ç·šä¸Šï¼š<b id="onlineLabel" class="mono">0</b>
        </span>

        <input id="roomId" type="text" placeholder="Room IDï¼ˆä¾‹å¦‚ aion2-01ï¼‰" />
        <button class="btn primary" id="btnJoin">åŠ å…¥/å»ºç«‹æˆ¿é–“</button>
        <button class="btn" id="btnCopyLink">è¤‡è£½æˆ¿é–“é€£çµ</button>
      </div>

      <div class="lockBanner" id="lockBanner">åŒæ­¥ä¸­ï¼Œæ“ä½œå·²æš«æ™‚é–å®šâ€¦</div>
    </div>

    <div class="controls">
      <button class="btn" id="btnExport">åŒ¯å‡ºå‚™ä»½</button>
      <button class="btn" id="btnImport">åŒ¯å…¥å‚™ä»½</button>
      <input type="file" id="fileImport" accept="application/json" style="display:none" />

      <button class="btn danger" id="btnResetLocal">é‡ç½®æœ¬æ©Ÿè³‡æ–™</button>

      <span class="chip" title="æ´»å‹•æ¨¡å¼ï¼šå¤šæ•¸é‡ç”Ÿæ™‚é–“æ¸›åŠï¼ˆæ·±æ·µæœ‰ä¾‹å¤–ï¼‰">
        <label style="display:flex;gap:8px;align-items:center;cursor:pointer;">
          <input type="checkbox" id="chkEvent" />
          æ´»å‹•æ¨¡å¼
        </label>
      </span>

      <span class="chip">
        <label style="display:flex;gap:8px;align-items:center;cursor:pointer;">
          <input type="checkbox" id="chkSound" />
          å•Ÿç”¨æé†’éŸ³
        </label>
      </span>

      <span class="chip" style="display:flex;gap:8px;align-items:center;">
        å­—é«”
        <select id="selFont" class="btn" style="padding:8px 10px">
          <option value="sm">å°</option>
          <option value="md" selected>ä¸­</option>
          <option value="lg">å¤§</option>
        </select>
      </span>

      <span class="chip" title="åªé¡¯ç¤ºä½ å·²æ”¶è—ï¼ˆâ­ï¼‰çš„ BOSSï¼ˆæœ¬æ©Ÿåå¥½ï¼‰">
        <label style="display:flex;gap:8px;align-items:center;cursor:pointer;">
          <input type="checkbox" id="chkOnlyFav" />
          åªçœ‹æ”¶è—
        </label>
      </span>

      <span class="chip" style="display:flex;gap:8px;align-items:center;">
        å³å°‡åˆ·æ–°éŸ³æ•ˆ
        <select id="selSoundWarn" class="btn" style="padding:8px 10px">
          <option value="soft">æŸ”å’Œï¼ˆå–®è²ï¼‰</option>
          <option value="sharp" selected>æ¸…è„†ï¼ˆå–®è²ï¼‰</option>
          <option value="double">é›™è²ï¼ˆå®å®ï¼‰</option>
          <option value="alarm">è­¦å‘Šï¼ˆçŸ­ä¿ƒï¼‰</option>
          <option value="file">éŸ³æª”ï¼ˆalert.mp3ï¼‰</option>
        </select>
      </span>

      <span class="chip" style="display:flex;gap:8px;align-items:center;">
        å·²åˆ·æ–°éŸ³æ•ˆ
        <select id="selSoundSpawn" class="btn" style="padding:8px 10px">
          <option value="soft">æŸ”å’Œï¼ˆå–®è²ï¼‰</option>
          <option value="sharp">æ¸…è„†ï¼ˆå–®è²ï¼‰</option>
          <option value="double" selected>é›™è²ï¼ˆå®å®ï¼‰</option>
          <option value="alarm">è­¦å‘Šï¼ˆçŸ­ä¿ƒï¼‰</option>
          <option value="file">éŸ³æª”ï¼ˆalert.mp3ï¼‰</option>
        </select>
      </span>

      <span class="chip" style="display:flex;gap:10px;align-items:center;">
        éŸ³é‡
        <input type="range" id="rngVol" min="0" max="100" value="60" />
        <button class="btn" id="btnMute">éœéŸ³</button>
      </span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="tabs" id="tabs"></div>
      <div class="body">
        <div class="row" style="align-items:flex-end;">
          <div class="kpi">
            <span class="chip">æé†’æå‰ <input id="notifyMin" type="number" min="0" max="180" style="width:84px" /> åˆ†é˜</span>
            <span class="chip">æ´»å‹•ï¼š<b id="eventLabel">OFF</b></span>
            <span class="chip">æˆ¿é–“ï¼š<span class="mono" id="roomLabel">ï¼ˆæœªåŠ å…¥ï¼‰</span></span>
          </div>
          <div class="kpi">
            <button class="btn primary" id="btnAddBoss">ï¼‹æ–°å¢ BOSS</button>
            <button class="btn" id="btnAddChannel">ï¼‹æ–°å¢åˆ†æµ</button>
          </div>
        </div>

        <div class="hint">
          <b>ã€Œæ“Šæ®ºã€</b>ï¼æŠŠä¸‹ä¸€æ¬¡åˆ·æ–°æ™‚é–“è¨­ç‚ºã€Œç¾åœ¨ + é‡ç”Ÿæ™‚é–“ã€ã€‚<b>ã€Œæ‰‹å‹•è¨­å®šã€</b>ç‚ºã€Œå–®ä¸€æ¬„ä½æ™‚é–“ã€è¼¸å…¥ï¼ˆ073015/7:30:15 çš†å¯ï¼Œæœƒè‡ªå‹•è®Š 07:30:15ï¼›æ—¥æœŸå›ºå®šä»Šå¤©ï¼‰ã€‚<br>
          BOSS åˆ·æ–°æ™‚æœƒé€²å…¥å³å´çš„ <b>ã€Œæœ€è¿‘é‡ç”Ÿã€</b>ï¼›åˆ·æ–°å¾Œ <b>15 ç§’</b> æœƒè‡ªå‹•é–‹å§‹ä¸‹ä¸€è¼ªå€’æ•¸ï¼Œä½†ä»ä¿ç•™åœ¨æœ€è¿‘é‡ç”Ÿï¼Œç›´åˆ° <b>10 åˆ†é˜</b> å¾Œè‡ªå‹•å¿½ç•¥ç§»å‡ºåˆ—è¡¨ï¼ˆæˆ–ä½ æŒ‰ã€Œæ“Šæ®º/å¿½ç•¥ã€ç«‹åˆ»ç§»é™¤ï¼‰ã€‚
        </div>

        <div class="list" id="bossList"></div>
      </div>
    </div>

    <div class="card">
      <div class="body">

        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <b>ğŸŸ  æœ€è¿‘é‡ç”Ÿ</b>

          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <label class="chip" style="display:flex;gap:6px;align-items:center;cursor:pointer;padding:6px 10px">
              <input type="checkbox" id="recentChkEly" checked />
              å¤©æ—
            </label>
            <label class="chip" style="display:flex;gap:6px;align-items:center;cursor:pointer;padding:6px 10px">
              <input type="checkbox" id="recentChkAsmo" checked />
              é­”æ—
            </label>
            <label class="chip" style="display:flex;gap:6px;align-items:center;cursor:pointer;padding:6px 10px">
              <input type="checkbox" id="recentChkAbyss" checked />
              æ·±æ·µ
            </label>

            <span class="badge" id="recentCount">0</span>
          </div>
        </div>
        <div id="recentBox"></div>

        <div class="hr" style="margin:14px 0;"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
          <b>â­ æ”¶è—</b>
          <span class="badge" id="favCount">0</span>
        </div>
        <div id="favBox"></div>

        <div class="hint" style="margin-top:14px">
          â€» å­—é«”å¤§å° / åªçœ‹æ”¶è— / æç¤ºéŸ³é¸å–® / æœ€è¿‘é‡ç”Ÿç¯©é¸ ç‚ºæœ¬æ©Ÿåå¥½ï¼Œä¸æœƒåŒæ­¥åˆ°æˆ¿é–“ã€‚
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modalMask" id="timeMask" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="timeTitle">
    <div class="modalHead">
      <b id="timeTitle">æ‰‹å‹•è¨­å®šä¸Šæ¬¡æ“Šæ®ºæ™‚é–“ï¼ˆä»Šå¤©ï¼‰</b>
      <span class="badge" id="timeDateBadge"></span>
    </div>
    <div class="modalBody">
      <div class="hint" style="margin-top:0">
        è«‹è¼¸å…¥ <b>073015</b> æˆ– <b>7:30:15</b>ï¼Œæœƒè‡ªå‹•è½‰æˆ <b>07:30:15</b>ã€‚æ—¥æœŸå›ºå®šä»Šå¤©ã€‚
      </div>

      <div class="modalRow" style="margin-top:12px">
        <span class="chip">æ™‚é–“ï¼ˆHHMMSS æˆ– HH:MM:SSï¼‰
          <input id="tp_time" type="text" inputmode="numeric"
                 placeholder="ä¾‹å¦‚ 073015 æˆ– 7:30:15"
                 style="width:200px">
        </span>
        <button class="btn" id="tp_now" title="å¿«é€Ÿå¡«å…¥ç›®å‰æ™‚é–“">ç¾åœ¨</button>
      </div>
    </div>
    <div class="modalFoot">
      <button class="btn" id="tp_cancel">å–æ¶ˆ</button>
      <button class="btn primary" id="tp_ok">ç¢ºå®š</button>
    </div>
  </div>
</div>

<div class="modalMask" id="backupMask" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="backupTitle">
    <div class="modalHead">
      <b id="backupTitle">åŒ¯å…¥å‚™ä»½ï½œæ‘˜è¦</b>
      <span class="badge" id="backupBadge">JSON</span>
    </div>
    <div class="modalBody">
      <div class="hint" style="margin-top:0">
        åŒ¯å…¥æœƒ<b>è¦†è“‹ç›®å‰è³‡æ–™</b>ã€‚å¦‚æœä½ å·²åŠ å…¥æˆ¿é–“ï¼Œå¯é¸æ“‡æ˜¯å¦åŒæ­¥åˆ°æˆ¿é–“ï¼ˆæœƒå½±éŸ¿æ‰€æœ‰äººï¼‰ã€‚
      </div>

      <div class="hr"></div>

      <div class="kv" id="backupKv"></div>

      <div class="hr"></div>

      <div class="hint" id="backupWarn" style="margin-top:0"></div>
    </div>
    <div class="modalFoot" id="backupFoot">
      <button class="btn" id="backupCancel">å–æ¶ˆ</button>
      <button class="btn primary" id="backupImportLocal">åªåŒ¯å…¥æœ¬æ©Ÿ</button>
      <button class="btn danger" id="backupImportSync" style="display:none">åŒ¯å…¥ä¸¦åŒæ­¥åˆ°æˆ¿é–“</button>
    </div>
  </div>
</div>

<script type="module">
  // çµ±ä¸€ä½¿ç”¨ v10 æ¨¡çµ„åŒ– SDK
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js';
  import {
    getFirestore,
    doc, setDoc, onSnapshot,
    serverTimestamp,
    collection,
    runTransaction
  } from 'https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js';

  // Realtime Database æ¨¡çµ„ç”¨æ–¼ Presence
  import { 
    getDatabase, 
    ref as dbRef, 
    set as dbSet, 
    onValue, 
    onDisconnect, 
    remove as dbRemove
  } from 'https://www.gstatic.com/firebasejs/10.10.0/firebase-database.js';

  // âœ… ä½ çš„ Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyB48T3mjUO20-PbKLdgVOU6p3Ega4Oe2p8",
    authDomain: "aion-2-timer.firebaseapp.com",
    databaseURL: "https://aion-2-timer-default-rtdb.firebaseio.com", // RTDB URL for presence
    projectId: "aion-2-timer",
    storageBucket: "aion-2-timer.firebasestorage.app",
    messagingSenderId: "385544715160",
    appId: "1:385544715160:web:25c0b9ba8c380226cb89ed",
    measurementId: "G-3Q914TBN8P"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const rtdb = getDatabase(app); // åˆå§‹åŒ– Realtime Database

  // =========================
  // Client IDï¼ˆæˆ¿ä¸»ã€åŠ å…¥åºã€ç·šä¸Šç‹€æ…‹ï¼‰
  // =========================
  const CLIENT_KEY = "aion2_bosstimer_client_id_v1";
  function getClientId(){
    let id = localStorage.getItem(CLIENT_KEY);
    if(!id){
      id = "c-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
      localStorage.setItem(CLIENT_KEY, id);
    }
    return id;
  }
  const clientId = getClientId();

  // =========================
  // åŸºæœ¬è³‡æ–™
  // =========================
  const now = () => Date.now();
  const uid = (p) => `${p}-${Math.random().toString(16).slice(2,9)}${Date.now().toString(16).slice(-4)}`;

  // âœ… ä½ ç›®å‰çš„é è¨­ BOSSï¼ˆå¯è‡ªè¡Œç·¨è¼¯/æ–°å¢ï¼‰
  const preset = {
    channels: [
      { name:"å¤©æ—", bosses:[
        ["è¥¿å´å‡±çˆ¾è¾²",60,30,"åå¡”æ–¯æºªè°·",""],
        ["æ±å´æ¶…å‡±çˆ¾",60,30,"åå¡”æ–¯æºªè°·",""],
        ["è…æœ½çš„åº«å¡”çˆ¾",60,30,"è‰¾é›·å€«æ²³æ²¼æ¾¤",""],
        ["ç››é–‹çš„æŸ¯æ—",120,60,"è‰¾é›·å€«æ²³ä¸­æ¸¸",""],
        ["è­·è¡›å…µå ¤ç”˜ç‰¹",180,90,"è¦å¡å»¢å¢Ÿ",""],
        ["ç‹‚é¬¥å£«åº«æ¡‘",240,120,"è¦å¡å»¢å¢Ÿ",""],
        ["ç¥­å¸é•·åŠ çˆ¾æ–°",240,120,"è¦å¡å»¢å¢Ÿ",""],
        ["è¡€ç ç‰™æ™®å¯§",360,180,"è¦å¡å»¢å¢Ÿ",""],
        ["æ†¤æ€’çš„è–©å‘‚",360,180,"è¦å¡å»¢å¢Ÿ",""],
        ["å­¸è€…æ‹‰çƒæ‹‰",240,120,"æ‰˜çˆ¾å·´æ–¯æ£®æ—",""],
        ["è¿½æ“Šè€…å¡”çƒç¾…",240,120,"é˜¿çˆ¾æ‹‰å³¶éƒ¨è½",""],
        ["æ£®æ—æˆ°å£«çƒåˆºå§†",480,240,"é˜¿çˆ¾æ‹‰å³¶éƒ¨è½",""],
        ["é»‘è‰²è§¸æ‰‹æ‹‰ç“¦",480,240,"é˜¿çˆ¾æ‹‰å³¶éƒ¨è½",""],
        ["å›æ•™è€…é›·è¥¿æ‹‰",360,180,"é˜¿çˆ¾å¡”ç±³äºå³½è°·",""],
        ["ç™¾å¤«é•·æˆ´ç±³ç¾…æ–¯",480,240,"é˜¿çˆ¾å¡”ç±³äºé«˜åŸ",""],
        ["ç¥è–çš„å®‰è–©æ–¯",720,360,"é˜¿çˆ¾å¡”ç±³äºé«˜åŸ",""],
        ["æ”¶ç©«ç®¡ç†è€…è«å¤å¤«",360,180,"å¾·æ‹‰é‚£æ ½åŸ¹åœ°",""],
        ["ç›£è¦–å…µå™¨å…‹ç´è¨±",480,240,"ç´å¸Œå¾·è»åœ˜è¦å¡",""],
        ["ç ”ç©¶å®˜å¡ç‰¹è˜­",720,360,"ç´å¸Œå¾·è»åœ˜è¦å¡",""],
        ["å¹»å¤¢å¡è¥¿äº",720,360,"å¹»å½±ç¥åº­é™¢",""],
        ["æ²‰é»˜å¡”çˆ¾å¦",720,360,"é˜¿çˆ¾å¡”ç±³äºé«˜åŸå—éƒ¨",""],
        ["éˆé­‚æ”¯é…è€…å¡æ²™å¸•",720,360,"é˜¿çˆ¾å¡”ç±³äºé«˜åŸæ±éƒ¨",""],
        ["è»åœ˜é•·æ‹‰æ ¼å¡”",1440,720,"ç´…è‰²æ£®æ—",""],
        ["æ°¸æ†å¡çˆ¾åäº",1440,720,"æ°¸æ†ä¹‹å³¶",""],
      ]},
      { name:"é­”æ—", bosses:[
        ["èåŒ–çš„é”ç´çˆ¾",60,30,"å¾·é›·å¾—å¥‡å®‰å¤±äº‹åœ°",""],
        ["é»‘è‰²æˆ°å£«é˜¿åŸƒå¾·",60,30,"ç„¡åå¢“åœ°",""],
        ["å¿ å¯¦çš„æ‹‰å‰ç‰¹",60,30,"è–æ‰€ç›£è¦–å“¨æ‰€",""],
        ["ç‹‚æˆ°å£«ç“¦æ ¼",120,60,"è–æ‰€ç›£è¦–å“¨æ‰€",""],
        ["è¡€æˆ°å£«è˜­é‚£çˆ¾",180,90,"è–æ‰€ç›£è¦–å“¨æ‰€",""],
        ["æ é£Ÿè€…åŠ çˆ¾æ¡‘",240,120,"ç‘ªæ–¯è˜­æ£®æ—",""],
        ["æ¬ºçè€…ç‰¹é‡Œå¾·",240,120,"çƒç‘ªé€šæµ·å§†",""],
        ["è—è‰²æ°´æ³¢å‡±çˆ¾à¤ªà¥€é‚£",240,120,"æ·¨åŒ–ä¹‹æ£®",""],
        ["åƒè¬€å®˜å‹’æ²™ç´",360,180,"æ·¨åŒ–ä¹‹æ£®",""],
        ["æ²‰é»˜å¡”çˆ¾å¦",720,360,"æ·¨åŒ–ä¹‹æ£®",""],
        ["ç¸½ç›£ç£å®˜åŠªå¡”",240,120,"å¾·æ‹‰é‚£å…’åœ’æ–·",""],
        ["åˆ¥å‹•éšŠé•·ä»¤å…‹æ–¯",360,180,"å¾·æ‹‰é‚£å…’åœ’æ–·",""],
        ["è¤»ç€†è€…è«¾å¸ƒé­¯å¾·",480,240,"å·´æ–¯æ–çˆ¾ç‰¹å»¢å¢Ÿ",""],
        ["äº¡é­‚åŸ·æ”¿å®˜äºå…‹å¸­æ­æ–¯",480,240,"å·´æ–¯æ–çˆ¾ç‰¹å»¢å¢Ÿ",""],
        ["ä¸­æ¯’çš„å“ˆè¿ªå€«",360,180,"æ³•å¤«å¥ˆç‰¹åŸ‹è‘¬åœ°",""],
        ["éˆé­‚æ”¯é…è€…å¡æ²™å¸•",720,360,"æ³•å¤«å¥ˆç‰¹åŸ‹è‘¬åœ°",""],
        ["è™•åˆ‘è€…å·´çˆ¾è¥¿æ©",480,240,"è‘›åˆ©å·´å¾·å³½è°·è¥¿éƒ¨",""],
        ["å¾·æ‹‰åéƒ¨éšŠå…µå™¨å¤é­¯å¡”",720,360,"è‘›åˆ©å·´å¾·å³½è°·æ±éƒ¨",""],
        ["ç™¾æˆ°è€å°‡èˆ’æœ­å",360,180,"é»‘çˆªéƒ¨è½",""],
        ["ç§˜è¡“å¡é­¯å¡",480,240,"é»‘çˆªéƒ¨è½",""],
        ["é»‘é—‡æ¯”ä¿®è²é”",720,360,"é»‘çˆªéƒ¨è½",""],
        ["è»åœ˜é•·æ‹‰æ ¼å¡”",1440,720,"æ‹‰æ ¼å¡”è¦å¡",""],
        ["æ•éŠ³çš„æ•˜æ‹‰å…‹",720,360,"å› æ´¾åœ’è¥¿å§†å»£å ´",""],
        ["ä¸æ»…å¡çˆ¾åäº",1440,720,"ä¸æ»…ä¹‹å³¶",""],
      ]},
      { name:"æ·±æ·µ", bosses:[
        ["ç›£è¦–è€…å¡ä¼Šæ‹‰",60,60,"è‰¾é›·ä¿®è—å¡”ä¸‹å±¤","æ´»å‹•æ¨¡å¼æ™‚é–“ä¸è®Šï¼ˆå‡ºç¾æ©Ÿç‡â†‘ï¼‰"],
        ["ç²¾éˆç‹é˜¿æ ¼ç¾…",1440,720,"å¸ŒåŸƒçˆ¾ä¹‹ç¿¼ç¾¤å³¶ / å¸ŒåŸƒçˆ¾å³ç¿¼",""],
        ["å®ˆè­·ç¥å°‡ç´èµ«ç‘ª",0,0,"è‰¾é›·ä¿®è—å¡”ä¹‹æ ¹","éœ€æ‰‹å‹•æ“Šæ®ºå¾Œè¨ˆæ™‚ï¼ˆæ­¤ç‰ˆå…ˆæç¤ºï¼‰"],
      ]},
    ]
  };

  const defaultState = () => ({
    version: 8,
    settings: { soundEnabled:false, volume:0.60, muted:false, notifyBeforeMin:3, eventMode:false },
    activeChannelId: "ch-0",
    channels: preset.channels.map((ch, idx) => ({
      id: `ch-${idx}`,
      name: ch.name,
      bosses: ch.bosses.map((b, i) => ({
        id: uid("b"),
        name: b[0],
        baseMin: b[1],
        eventMin: b[2],
        location: b[3] || "",
        note: b[4] || "",
        lastKillAt: now() - (i%5)*12*60*1000,
        starred: false,
        notified: false
      }))
    }))
  });

  // =========================
  // LocalStorageï¼ˆè³‡æ–™ + UI åå¥½ï¼‰
  // =========================
  const LOCAL_KEY = "aion2_bosstimer_firebase_local_cache_v8";
  const loadLocal = () => { try { const raw = localStorage.getItem(LOCAL_KEY); return raw ? JSON.parse(raw) : null; } catch { return null; } };
  const saveLocal = (s) => localStorage.setItem(LOCAL_KEY, JSON.stringify(s));

  const UI_KEY = "aion2_bosstimer_firebase_ui_pref_v8";
  const loadUI = () => { try { const raw = localStorage.getItem(UI_KEY); return raw ? JSON.parse(raw) : null; } catch { return null; } };
  const saveUI = (ui) => localStorage.setItem(UI_KEY, JSON.stringify(ui));

  let uiPref = loadUI() || {
    font: "md",
    onlyFav: false,
    soundWarn: "sharp",
    soundSpawn: "double",
    recentFilter: { ely: true, asmo: true, abyss: true } // âœ… æœ€è¿‘é‡ç”Ÿç¯©é¸
  };
  uiPref.recentFilter ||= { ely: true, asmo: true, abyss: true };

  let state = loadLocal() || defaultState();

  function normalizeState(s){
    if(!s || !s.channels) return s;
    for(const ch of s.channels){
      ch.bosses ||= [];
      for(const b of ch.bosses){
        if(b.location === undefined) b.location = "";
        if(b.note === undefined) b.note = "";
        if(b.notified === undefined) b.notified = false;
        if(b.starred === undefined) b.starred = false;
        if(b.lastKillAt === undefined) b.lastKillAt = now();
        // âœ… æœ€è¿‘é‡ç”Ÿæ¬„ä½
        // _recentShownAt: number
        // _recentIgnored: boolean
      }
    }
    if(!s.settings) s.settings = { soundEnabled:false, volume:0.60, muted:false, notifyBeforeMin:3, eventMode:false };
    if(s.settings.notifyBeforeMin === undefined) s.settings.notifyBeforeMin = 3;
    if(s.settings.eventMode === undefined) s.settings.eventMode = false;
    if(s.settings.volume === undefined) s.settings.volume = 0.60;
    if(s.settings.muted === undefined) s.settings.muted = false;
    if(s.settings.soundEnabled === undefined) s.settings.soundEnabled = false;
    if(!s.activeChannelId && s.channels?.[0]?.id) s.activeChannelId = s.channels[0].id;
    return s;
  }
  state = normalizeState(state);
  saveLocal(state);

  // =========================
  // Firestoreï¼šæˆ¿é–“åŒæ­¥ + Realtime DBï¼šPresence
  // =========================
  let roomId = "";
  let unsubRoom = null;

  // Firestore Docs
  const roomDocRef = () => doc(db, "rooms", roomId);
  // Realtime DB Refs for Presence
  const presenceRef = () => dbRef(rtdb, "rooms_presence/" + roomId + "/online_users/" + clientId);
  const usersRef = () => dbRef(rtdb, "rooms_presence/" + roomId + "/online_users");
  
  // UIï¼šèº«åˆ†/åŠ å…¥åº/ç·šä¸Šæ•¸
  const roleLabel = document.querySelector("#roleLabel");
  const joinIndexLabel = document.querySelector("#joinIndexLabel");
  const onlineLabel = document.querySelector("#onlineLabel");

  let isHost = false;
  let joinIndex = null;

  // UI lock
  const lockBanner = document.querySelector("#lockBanner");
  function setLocked(lock, text){
    document.body.classList.toggle("locked", !!lock);
    if(text) lockBanner.textContent = text;
  }

  // cloud status chip
  const dot = document.querySelector("#dot");
  const cloudStatus = document.querySelector("#cloudStatus");
  function setCloudStatus(text, ok=null){
    cloudStatus.textContent = text;
    dot.classList.toggle("ok", ok === true);
    dot.classList.toggle("bad", ok === false);
  }

  // presence / heartbeat
  let unsubPresence = null;
  
  // ä½¿ç”¨ Realtime DB å¯¦ç¾ Presence
  async function startPresence(){
    // 1. åœ¨ RTDB å¯«å…¥ Presence æ–‡ä»¶
    await dbSet(presenceRef(), {
      clientId,
      // ä½¿ç”¨ç•¶å‰æ™‚é–“æˆ³
      joinedAt: Date.now(), 
      lastSeen: Date.now() 
    });
    
    // 2. è¨­å®šæ–·ç·šæ™‚ï¼ˆç€è¦½å™¨é—œé–‰/ç¶²è·¯æ–·é–‹ï¼‰è‡ªå‹•å°‡æ­¤æ–‡ä»¶ç§»é™¤
    onDisconnect(presenceRef()).remove();

    // 3. ç›£è½ç·šä¸Šä½¿ç”¨è€…è¨ˆæ•¸
    if(unsubPresence) unsubPresence();
    
    unsubPresence = onValue(usersRef(), (snapshot) => {
      const users = snapshot.val();
      const alive = users ? Object.keys(users).length : 0;
      onlineLabel.textContent = String(alive);
    }, (err) => {
      console.warn("RTDB Presence ç›£è½å¤±æ•—ï¼š", err);
      onlineLabel.textContent = "0";
    });
  }

  function stopPresence(){
    if(unsubPresence){ unsubPresence(); unsubPresence = null; }
    // ç¢ºä¿é›¢é–‹æˆ¿é–“æ™‚æ¸…é™¤ onDisconnect è™•ç†ï¼Œä¸¦ç«‹å³ç§»é™¤è‡ªå·±çš„ presence ç´€éŒ„
    onDisconnect(presenceRef()).cancel();
    dbRemove(presenceRef());
  }

  // âœ… Transactionï¼šå»ºç«‹æˆ¿é–“ metaï¼ˆhostId/joinSeqï¼‰ä¸¦è¿”å›åŠ å…¥åº
  async function ensureRoomAndJoinMeta(){
    const ref = roomDocRef();
    const result = await runTransaction(db, async (tx) => {
      const snap = await tx.get(ref);
      const existed = snap.exists();

      if(!existed){
        const hostId = clientId;
        tx.set(ref, {
          meta: { hostId, joinSeq: 1, createdAt: serverTimestamp() },
          state,
          updatedAt: serverTimestamp()
        }, { merge: true });

        return { existed:false, hostId, joinIndex:1 };
      }

      const data = snap.data() || {};
      const hostId = data?.meta?.hostId || null;
      const seq = Number(data?.meta?.joinSeq || 0) + 1;

      tx.set(ref, { meta: { joinSeq: seq } }, { merge: true });
      return { existed:true, hostId, joinIndex:seq };
    });

    joinIndex = result.joinIndex;
    isHost = (result.hostId === clientId);

    roleLabel.textContent = isHost ? "æˆ¿ä¸»" : "æˆå“¡";
    joinIndexLabel.textContent = String(joinIndex);

    return result.existed;
  }

  let applyingRemote = false;
  let firstSnapshotArrived = false;

  function startRoomListen(){
    if(unsubRoom) unsubRoom();
    const ref = roomDocRef();

    firstSnapshotArrived = false;

    unsubRoom = onSnapshot(ref, (snap) => {
      if(!snap.exists()) return;
      const data = snap.data();
      if(!data?.state) return;

      applyingRemote = true;
      state = normalizeState(data.state);
      saveLocal(state);
      render();
      applyingRemote = false;

      if(!firstSnapshotArrived){
        firstSnapshotArrived = true;
        setLocked(false);
      }

      // æ›´æ–°æˆ¿ä¸»é¡¯ç¤ºï¼ˆè‹¥ meta.hostId å­˜åœ¨ï¼‰
      const hostId = data?.meta?.hostId;
      if(hostId){
        isHost = (hostId === clientId);
        roleLabel.textContent = isHost ? "æˆ¿ä¸»" : "æˆå“¡";
      }

      setCloudStatus("å·²åŒæ­¥å®Œæˆ", true);
    }, (err) => {
      console.error(err);
      setCloudStatus("é€£ç·šå¤±æ•—ï¼ˆçœ‹ Console/Rulesï¼‰", false);
      setLocked(false);
    });
  }

  async function pushToCloud(){
    if(!roomId) return;
    if(applyingRemote) return;
    try{
      await setDoc(roomDocRef(), { state, updatedAt: serverTimestamp() }, { merge: true });
      setCloudStatus("å·²åŒæ­¥å®Œæˆ", true);
    }catch(e){
      console.error(e);
      setCloudStatus("å¯«å…¥å¤±æ•—ï¼ˆçœ‹ Rules/Consoleï¼‰", false);
    }
  }

  // =========================
  // UI / å€’æ•¸
  // =========================
  const $ = (q) => document.querySelector(q);
  const tabsEl = $("#tabs");
  const listEl = $("#bossList");
  const recentBox = $("#recentBox");
  const recentCount = $("#recentCount");
  const favBox = $("#favBox");
  const favCount = $("#favCount");

  const chkSound = $("#chkSound");
  const chkEvent = $("#chkEvent");
  const rngVol = $("#rngVol");
  const btnMute = $("#btnMute");
  const notifyMin = $("#notifyMin");
  const eventLabel = $("#eventLabel");
  const roomLabel = $("#roomLabel");

  const selFont = $("#selFont");
  const chkOnlyFav = $("#chkOnlyFav");
  const selSoundWarn = $("#selSoundWarn");
  const selSoundSpawn = $("#selSoundSpawn");

  // âœ… æœ€è¿‘é‡ç”Ÿç¯©é¸ï¼ˆæœ¬æ©Ÿåå¥½ï¼‰
  const recentChkEly = $("#recentChkEly");
  const recentChkAsmo = $("#recentChkAsmo");
  const recentChkAbyss = $("#recentChkAbyss");

  const btnExport = $("#btnExport");
  const btnImport = $("#btnImport");
  const fileImport = $("#fileImport");

  function applyRecentFilterToUI(){
    recentChkEly.checked = !!uiPref.recentFilter.ely;
    recentChkAsmo.checked = !!uiPref.recentFilter.asmo;
    recentChkAbyss.checked = !!uiPref.recentFilter.abyss;
  }

  recentChkEly.onchange = () => {
    uiPref.recentFilter.ely = recentChkEly.checked;
    saveUI(uiPref);
    render();
  };
  recentChkAsmo.onchange = () => {
    uiPref.recentFilter.asmo = recentChkAsmo.checked;
    saveUI(uiPref);
    render();
  };
  recentChkAbyss.onchange = () => {
    uiPref.recentFilter.abyss = recentChkAbyss.checked;
    saveUI(uiPref);
    render();
  };

  // ===== æç¤ºéŸ³ï¼ˆé¸å–® + ä¸åŒç‹€æ…‹ï¼‰=====
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
  }

  let alertAudio = null;
  function playFileAlert(){
    try{
      if(!alertAudio){
        alertAudio = new Audio("alert.mp3");
        alertAudio.preload = "auto";
      }
      alertAudio.volume = Math.max(0, Math.min(1, state.settings.volume ?? 0.6));
      alertAudio.currentTime = 0;
      alertAudio.play().catch(()=>{});
    }catch(e){
      console.warn("éŸ³æª”æç¤ºéŸ³æ’­æ”¾å¤±æ•—ï¼š", e);
    }
  }

  function playTone({ type="triangle", freq=880, dur=0.26 }){
    ensureAudio();
    const t = audioCtx.currentTime;

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = type;
    osc.frequency.setValueAtTime(freq, t);

    const vol = Math.max(0, Math.min(1, state.settings.volume ?? 0.6));
    gain.gain.setValueAtTime(0.0001, t);
    gain.gain.exponentialRampToValueAtTime(0.35 * vol, t + 0.02);
    gain.gain.exponentialRampToValueAtTime(0.0001, t + dur);

    osc.connect(gain).connect(audioCtx.destination);
    osc.start(t);
    osc.stop(t + dur + 0.02);
  }

  function playDouble(){
    ensureAudio();
    const base = audioCtx.currentTime;
    const vol = Math.max(0, Math.min(1, state.settings.volume ?? 0.6));

    const one = (start) => {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "triangle";
      osc.frequency.setValueAtTime(880, start);
      gain.gain.setValueAtTime(0.0001, start);
      gain.gain.exponentialRampToValueAtTime(0.35 * vol, start + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, start + 0.20);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start(start);
      osc.stop(start + 0.22);
    };

    one(base);
    one(base + 0.28);
  }

  function beep(kind = "warn"){
    if(!state.settings.soundEnabled || state.settings.muted) return;

    const mode = (kind === "spawn")
      ? (uiPref.soundSpawn || "double")
      : (uiPref.soundWarn || "sharp");

    if(mode === "file"){ playFileAlert(); return; }
    if(mode === "double"){ playDouble(); return; }
    if(mode === "soft"){ playTone({ type:"sine", freq:660, dur:0.30 }); return; }
    if(mode === "alarm"){ playTone({ type:"square", freq:900, dur:0.18 }); return; }

    playTone({ type:"triangle", freq:1200, dur:0.22 }); // sharp
  }

  const pad2 = n => String(n).padStart(2,"0");
  const fmtDuration = (ms) => {
    ms = Math.max(0, ms);
    const s = Math.floor(ms/1000);
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    return `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
  };
  const fmtTime = (ts) => {
    const d = new Date(ts);
    // ä¿®æ­£ï¼šç¾åœ¨ time è¼¸å‡ºä¹ŸåŒ…å«ç§’
    return `${pad2(d.getMonth()+1)}/${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  };
  const fmtDate = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const escapeHtml = (s) => String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");

  const activeChannel = () => state.channels.find(c => c.id === state.activeChannelId) || state.channels[0];
  const respawnMin = (b) => {
    const em = state.settings.eventMode;
    const m = em ? (b.eventMin ?? b.baseMin) : (b.baseMin ?? b.eventMin);
    return Math.max(0, Number(m)||0);
  };
  const nextSpawn = (b) => (b.lastKillAt ?? 0) + respawnMin(b) * 60 * 1000;
  const sortBosses = (arr) => [...arr].sort((a,b)=> nextSpawn(a)-nextSpawn(b));
  const computeStatus = (remainMs, notifyBeforeMin) => {
    const notifyMs = (notifyBeforeMin ?? 0) * 60 * 1000;
    if(remainMs <= 0) return {text:"å·²åˆ·æ–°", cls:"danger"};
    if(remainMs <= notifyMs) return {text:`å³å°‡åˆ·æ–°ï¼ˆâ‰¤${notifyBeforeMin} åˆ†ï¼‰`, cls:"warn"};
    return {text:"è¨ˆæ™‚ä¸­", cls:"good"};
  };
  const mkBtn = (text, cls, onClick) => {
    const b = document.createElement("button");
    b.className = cls;
    b.textContent = text;
    b.onclick = onClick;
    return b;
  };
  const allStarred = () => {
    const out = [];
    for(const ch of state.channels) for(const b of ch.bosses) if(b.starred) out.push({ch,b});
    return out.sort((x,y)=> nextSpawn(x.b)-nextSpawn(y.b));
  };

  // =========================
  // ğŸŸ  æœ€è¿‘é‡ç”Ÿï¼šæ”¶é›†/æ¸²æŸ“ï¼ˆæœ€å¤šé¡¯ç¤º 10 éš» + åˆ†é¡ç¯©é¸ï¼‰
  // =========================
  function getRecentRespawns(){
    const items = [];
    const TTL_MS = 10 * 60 * 1000; // âœ… ä¿®æ­£ï¼šæœ€è¿‘é‡ç”Ÿä¿ç•™ 10 åˆ†é˜
    const t = now();

    for(const ch of state.channels){
      const nm = (ch.name || "").trim();
      const kind =
        /å¤©æ—/.test(nm) ? "ely" :
        /é­”æ—/.test(nm) ? "asmo" :
        /æ·±æ·µ/.test(nm) ? "abyss" : "other";

      if(kind !== "other" && uiPref?.recentFilter && uiPref.recentFilter[kind] === false){
        continue; // âœ… è©²åˆ†é¡æ²’å‹¾é¸å°±è·³éæ•´å€‹åˆ†æµ
      }

      for(const b of (ch.bosses || [])){
        if(b._recentShownAt && !b._recentIgnored){
          if(t - b._recentShownAt <= TTL_MS){
            items.push({ ch, b });
          }
        }
      }
    }
    items.sort((x,y) => (y.b._recentShownAt||0) - (x.b._recentShownAt||0));
    return items;
  }

  function renderRecentRespawns(){
    const itemsAll = getRecentRespawns();
    const items = itemsAll.slice(0, 10); // âœ… æœ€å¤šé¡¯ç¤º 10 éš»
    recentCount.textContent = String(items.length);
    recentBox.innerHTML = "";

    if(items.length === 0){
      const e = document.createElement("div");
      e.className = "tiny muted";
      e.style.marginTop = "10px";
      e.textContent = "ç›®å‰æ²’æœ‰ã€Œæœ€è¿‘é‡ç”Ÿã€çš„ BOSSã€‚";
      recentBox.appendChild(e);
      return;
    }

    for(const { ch, b } of items){
      const row = document.createElement("div");
      row.className = "favitem";

      const left = document.createElement("div");
      left.className = "left";

      const sinceMs = now() - (b._recentShownAt || now());
      const sinceMin = Math.floor(sinceMs / 60000);
      const sinceSec = Math.floor((sinceMs % 60000) / 1000);

      left.innerHTML = `
        <div style="display:flex;gap:8px;align-items:center;min-width:0;flex-wrap:wrap">
          <span class="badge">${escapeHtml(ch.name)}</span>
          ${b.location ? `<span class="badge">${escapeHtml(b.location)}</span>` : ""}
          <b style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(b.name)}</b>
        </div>
        <div class="tiny mono">
          å·²é‡ç”Ÿï¼š${pad2(sinceMin)}:${pad2(sinceSec)}
          <span class="muted">ï½œ</span> ä¸‹æ¬¡ï¼š${fmtTime(nextSpawn(b))}
        </div>
      `;

      const right = document.createElement("div");
      right.className = "actions";

      right.append(
        mkBtn("å‰å¾€", "btn", async () => {
          state.activeChannelId = ch.id;
          saveLocal(state);
          render();
          await pushToCloud();
          window.scrollTo({top:0, behavior:"smooth"});
        }),

        mkBtn("æ“Šæ®º", "btn good", async () => {
          b.lastKillAt = now();
          b.notified = false;

          // âœ… é»æ“Šæ®ºï¼šä»£è¡¨å·²è™•ç†ï¼Œç§»å‡ºæœ€è¿‘é‡ç”Ÿ
          delete b._recentShownAt;
          delete b._recentIgnored;

          saveLocal(state);
          render();
          await pushToCloud();
        }),

        mkBtn("å¿½ç•¥", "btn danger", async () => {
          // âœ… å¿½ç•¥ï¼šç«‹åˆ»ç§»å‡ºæœ€è¿‘é‡ç”Ÿ
          b._recentIgnored = true;
          delete b._recentShownAt;

          saveLocal(state);
          render();
          await pushToCloud();
        })
      );

      row.append(left, right);
      recentBox.appendChild(row);
    }
  }

  // =========================
  // æ‰‹å‹•æ™‚é–“è¼¸å…¥ Modalï¼ˆåªç•™ä¸€æ¬„ï¼šæ™‚é–“ï¼‰
  // =========================
  const timeMask = $("#timeMask");
  const tpTime = $("#tp_time");
  const tpOK = $("#tp_ok");
  const tpCancel = $("#tp_cancel");
  const tpNow = $("#tp_now");
  const timeDateBadge = $("#timeDateBadge");

  let timePickerResolve = null;

  /**
   * æ ¼å¼åŒ–æ™‚é–“è¼¸å…¥ï¼šHHMMSS -> HH:MM:SS
   */
  function formatTimeInput(input) {
    // åªä¿ç•™æ•¸å­—å’Œå†’è™Ÿï¼Œä¸¦ç§»é™¤é€£çºŒçš„å†’è™Ÿ
    let value = input.value.replace(/[^0-9:]/g, '').replace(/:{2,}/g, ':');
    const parts = value.split(':').map(p => p.trim()).filter(p => p.length > 0);
    
    // å¦‚æœæ˜¯ç´”æ•¸å­—è¼¸å…¥ï¼Œé€²è¡Œæ ¼å¼åŒ–
    if (parts.length === 0 && /^\d*$/.test(input.value)) {
      value = input.value.replace(/[^0-9]/g, '');
      if (value.length > 6) value = value.substring(0, 6);
      
      let formatted = '';
      if (value.length > 2) formatted += value.substring(0, 2) + ':';
      else formatted += value.substring(0, 2);

      if (value.length > 4) formatted += value.substring(2, 4) + ':';
      else formatted += value.substring(2, 4);

      formatted += value.substring(4);
      value = formatted;
    } else if (parts.length > 3) {
      // é¿å…éå¤šå†’è™Ÿåˆ†æ®µ
      value = parts.slice(0, 3).join(':');
    }
    
    // å„²å­˜å…‰æ¨™ä½ç½®
    const originalValue = input.value;
    const selectionStart = input.selectionStart;

    input.value = value;
    
    // æ¢å¾©å…‰æ¨™ä½ç½® (é‡å°éç´”æ•¸å­—è¼¸å…¥æ™‚ï¼Œå…‰æ¨™ä½ç½®å¯èƒ½å› è‡ªå‹•æ ¼å¼åŒ–è€Œç§»å‹•)
    if (originalValue.length === value.length) {
      input.setSelectionRange(selectionStart, selectionStart);
    } else if (selectionStart === originalValue.length) {
      // å¦‚æœå…‰æ¨™åœ¨æœ«å°¾ï¼Œå‰‡ä¿æŒåœ¨æœ«å°¾
      input.setSelectionRange(value.length, value.length);
    }
  }


  function openTimePicker(defaultTs){
    const base = defaultTs ? new Date(defaultTs) : new Date();
    const h = String(base.getHours()).padStart(2, "0");
    const m = String(base.getMinutes()).padStart(2, "0");
    const s = String(base.getSeconds()).padStart(2, "0");

    const today = new Date();
    timeDateBadge.textContent = fmtDate(today);

    // é è¨­å¡«å…¥ HH:MM:SS æ ¼å¼
    tpTime.value = `${h}:${m}:${s}`;
    tpTime.focus();

    timeMask.style.display = "flex";
    timeMask.setAttribute("aria-hidden", "false");

    return new Promise(resolve => { timePickerResolve = resolve; });
  }

  function closeTimePicker(){
    timeMask.style.display = "none";
    timeMask.setAttribute("aria-hidden", "true");
    timePickerResolve = null;
  }

  tpCancel.onclick = () => {
    if(timePickerResolve) timePickerResolve(null);
    closeTimePicker();
  };

  timeMask.addEventListener("click", (e) => {
    if(e.target === timeMask){
      if(timePickerResolve) timePickerResolve(null);
      closeTimePicker();
    }
  });

  tpNow.onclick = () => {
    const d = new Date();
    tpTime.value = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`;
    tpTime.dispatchEvent(new Event('input')); // è§¸ç™¼ä¸€æ¬¡æ ¼å¼åŒ–
  };

  tpTime.addEventListener("input", (e) => {
    // å¢åŠ å³æ™‚æ ¼å¼åŒ–åŠŸèƒ½ (HHMMSS -> HH:MM:SS)
    formatTimeInput(e.target);
  });
  
  tpOK.onclick = () => {
    let raw = (tpTime.value || "").trim();
    if(!raw){ alert("è«‹è¼¸å…¥æ™‚é–“ï¼Œä¾‹å¦‚ 073015 æˆ– 7:30:15"); tpTime.focus(); return; }

    let h, m, s;
    const parts = raw.split(':');

    if (parts.length === 3) {
      // æ ¼å¼: H:M:S
      h = Number(parts[0]);
      m = Number(parts[1]);
      s = Number(parts[2]);
    } else if (parts.length === 2) {
      // æ ¼å¼: H:M (ç§’æ•¸é è¨­ç‚º 0)
      h = Number(parts[0]);
      m = Number(parts[1]);
      s = 0;
    } else if (/^\d{3,6}$/.test(raw.replace(/:/g, ''))) {
      // æ ¼å¼: HHMMSS (ç´”æ•¸å­—ï¼Œé•·åº¦ 3~6)
      const cleaned = raw.replace(/:/g, '').padStart(6, '0');
      h = Number(cleaned.slice(0, 2));
      m = Number(cleaned.slice(2, 4));
      s = Number(cleaned.slice(4, 6));
    } else {
      alert("æ™‚é–“æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç”¨ HHMMSS æˆ– HH:MM:SS");
      tpTime.focus();
      return;
    }

    if(h < 0 || h > 23 || m < 0 || m > 59 || s < 0 || s > 59){
      alert("æ™‚é–“è¶…å‡ºç¯„åœï¼ˆ00:00:00 ï½ 23:59:59ï¼‰");
      tpTime.focus();
      return;
    }

    // æ›´æ–°è¼¸å…¥æ¡†é¡¯ç¤ºç‚ºæ¨™æº–æ ¼å¼
    tpTime.value = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;

    const d = new Date();
    d.setHours(h, m, s, 0); // è¨­å®šæ™‚ã€åˆ†ã€ç§’ï¼Œæ¯«ç§’å›ºå®šç‚º 0
    const ts = d.getTime();

    if(timePickerResolve) timePickerResolve(ts);
    closeTimePicker();
  };

  tpTime.addEventListener("keydown", (e) => { if(e.key === "Enter") tpOK.click(); });
  window.addEventListener("keydown", (e) => {
    if(e.key === "Escape" && timeMask.style.display === "flex"){
      if(timePickerResolve) timePickerResolve(null);
      closeTimePicker();
    }
  });
  
  // =========================
  // å‚™ä»½ï¼šåŒ¯å‡º / åŒ¯å…¥ + æ‘˜è¦
  // =========================
  const backupMask = $("#backupMask");
  const backupKv = $("#backupKv");
  const backupWarn = $("#backupWarn");
  const backupCancel = $("#backupCancel");
  const backupImportLocal = $("#backupImportLocal");
  const backupImportSync = $("#backupImportSync");
  let pendingBackup = null;

  function openBackupModal(summary){
    backupKv.innerHTML = summary.kv.map(([k,v]) => `
      <div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(v)}</div>
    `).join("");
    backupWarn.textContent = summary.warnText || "";
    backupImportSync.style.display = roomId ? "inline-flex" : "none";
    backupMask.style.display = "flex";
    backupMask.setAttribute("aria-hidden", "false");
  }
  function closeBackupModal(){
    backupMask.style.display = "none";
    backupMask.setAttribute("aria-hidden", "true");
    pendingBackup = null;
  }
  backupCancel.onclick = () => closeBackupModal();
  backupMask.addEventListener("click", (e) => { if(e.target === backupMask) closeBackupModal(); });

  function countBackupInfo(s){
    const chN = s?.channels?.length || 0;
    let bossN = 0, starredN = 0, hasTime = false;
    for(const ch of (s.channels || [])){
      bossN += (ch.bosses || []).length;
      for(const b of (ch.bosses || [])){
        if(b.starred) starredN++;
        if(typeof b.lastKillAt === "number") hasTime = true;
      }
    }
    return { chN, bossN, starredN, hasTime };
  }

  function buildBackupSummary(data){
    const st = data?.state;
    const meta = {
      exportedAt: data?.exportedAt || "",
      roomId: data?.roomId ?? null,
      version: data?.version ?? st?.version ?? "",
      fileName: data?.fileName || ""
    };
    const info = countBackupInfo(st);
    const exp = meta.exportedAt ? new Date(meta.exportedAt) : null;

    const kv = [
      ["æª”æ¡ˆ", meta.fileName || "ï¼ˆæœªæä¾›ï¼‰"],
      ["å‚™ä»½æ™‚é–“", exp && !isNaN(exp) ? exp.toLocaleString() : "ï¼ˆæœªçŸ¥ï¼‰"],
      ["å‚™ä»½ç‰ˆæœ¬", String(meta.version || "ï¼ˆæœªçŸ¥ï¼‰")],
      ["å‚™ä»½æˆ¿é–“", meta.roomId ? String(meta.roomId) : "ï¼ˆæœªè¨˜éŒ„ï¼‰"],
      ["åˆ†æµæ•¸", String(info.chN)],
      ["BOSS ç¸½æ•¸", String(info.bossN)],
      ["æ”¶è—æ•¸ï¼ˆâ­ï¼‰", String(info.starredN)],
      ["åŒ…å«æ™‚é–“è³‡æ–™", info.hasTime ? "æ˜¯" : "å¦"]
    ];

    let warnText = "";
    if(roomId && meta.roomId && meta.roomId !== roomId){
      warnText = `æ³¨æ„ï¼šæ­¤å‚™ä»½çš„æˆ¿é–“ç‚ºã€Œ${meta.roomId}ã€ï¼Œä½ ç›®å‰åŠ å…¥çš„æˆ¿é–“ç‚ºã€Œ${roomId}ã€ã€‚è‹¥é¸æ“‡ã€ŒåŒ¯å…¥ä¸¦åŒæ­¥åˆ°æˆ¿é–“ã€ï¼Œå°‡è¦†è“‹ç›®å‰æˆ¿é–“æ‰€æœ‰äººçš„è³‡æ–™ã€‚`;
    }else if(roomId && !meta.roomId){
      warnText = `æ³¨æ„ï¼šæ­¤å‚™ä»½æ²’æœ‰æˆ¿é–“è³‡è¨Šã€‚è‹¥é¸æ“‡ã€ŒåŒ¯å…¥ä¸¦åŒæ­¥åˆ°æˆ¿é–“ã€ï¼Œå°‡è¦†è“‹ç›®å‰æˆ¿é–“æ‰€æœ‰äººçš„è³‡æ–™ã€‚`;
    }else{
      warnText = `æç¤ºï¼šé¸ã€ŒåªåŒ¯å…¥æœ¬æ©Ÿã€åªå½±éŸ¿ä½ çš„ç€è¦½å™¨ï¼›é¸ã€ŒåŒ¯å…¥ä¸¦åŒæ­¥åˆ°æˆ¿é–“ã€æœƒè¦†è“‹æˆ¿é–“æ‰€æœ‰äººã€‚`;
    }

    return { kv, warnText, meta, info };
  }

  btnExport.onclick = () => {
    const payload = {
      version: state.version,
      exportedAt: new Date().toISOString(),
      roomId: roomId || null,
      state
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const ts = new Date();
    const name = `aion2-boss-backup-${ts.getFullYear()}${String(ts.getMonth()+1).padStart(2,"0")}${String(ts.getDate()).padStart(2,"0")}-${String(ts.getHours()).padStart(2,"0")}${String(ts.getMinutes()).padStart(2,"0")}.json`;
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  btnImport.onclick = () => fileImport.click();

  fileImport.onchange = async (e) => {
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      if(!data || !data.state || !Array.isArray(data.state.channels)){
        alert("å‚™ä»½æª”æ ¼å¼ä¸æ­£ç¢ºï¼ˆç¼ºå°‘ state/channelsï¼‰");
        return;
      }
      data.fileName = file.name;
      data.state = normalizeState(data.state);
      pendingBackup = data;
      openBackupModal(buildBackupSummary(pendingBackup));
    }catch(err){
      console.error(err);
      alert("åŒ¯å…¥å¤±æ•—ï¼šè«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦ç‚ºæœ‰æ•ˆ JSON");
    }finally{
      fileImport.value = "";
    }
  };

  async function applyImport({syncToRoom}){
    if(!pendingBackup?.state) return;
    state = normalizeState(pendingBackup.state);
    saveLocal(state);
    render();
    if(syncToRoom && roomId) await pushToCloud();
    closeBackupModal();
    alert(syncToRoom && roomId ? "åŒ¯å…¥å®Œæˆï¼ˆå·²åŒæ­¥åˆ°æˆ¿é–“ï¼‰" : "åŒ¯å…¥å®Œæˆï¼ˆåªå½±éŸ¿æœ¬æ©Ÿï¼‰");
  }

  backupImportLocal.onclick = async () => {
    if(!confirm("ç¢ºå®šè¦åŒ¯å…¥å‚™ä»½ä¸¦è¦†è“‹ç›®å‰è³‡æ–™ï¼ˆåªå½±éŸ¿æœ¬æ©Ÿï¼‰ï¼Ÿ")) return;
    await applyImport({syncToRoom:false});
  };

  backupImportSync.onclick = async () => {
    if(!roomId){ alert("ä½ å°šæœªåŠ å…¥æˆ¿é–“ï¼Œç„¡æ³•åŒæ­¥åˆ°æˆ¿é–“ã€‚"); return; }
    if(!confirm("âš ï¸ ç¢ºå®šè¦åŒ¯å…¥å‚™ä»½ä¸¦åŒæ­¥åˆ°æˆ¿é–“ï¼Ÿé€™æœƒè¦†è“‹æˆ¿é–“æ‰€æœ‰äººçš„è³‡æ–™ã€‚")) return;
    await applyImport({syncToRoom:true});
  };

  // =========================
  // Render
  // =========================
  function render(){
    document.documentElement.dataset.font = uiPref.font || "md";
    selFont.value = uiPref.font || "md";
    chkOnlyFav.checked = !!uiPref.onlyFav;
    selSoundWarn.value = uiPref.soundWarn || "sharp";
    selSoundSpawn.value = uiPref.soundSpawn || "double";

    applyRecentFilterToUI();

    chkSound.checked = !!state.settings.soundEnabled;
    chkEvent.checked = !!state.settings.eventMode;
    eventLabel.textContent = state.settings.eventMode ? "ON" : "OFF";
    eventLabel.style.color = state.settings.eventMode ? "var(--warn)" : "var(--muted)";
    rngVol.value = Math.round((state.settings.volume ?? 0.6)*100);
    btnMute.textContent = state.settings.muted ? "å–æ¶ˆéœéŸ³" : "éœéŸ³";
    notifyMin.value = state.settings.notifyBeforeMin ?? 3;
    roomLabel.textContent = roomId ? roomId : "ï¼ˆæœªåŠ å…¥ï¼‰";

    tabsEl.innerHTML = "";
    state.channels.forEach(ch => {
      const t = document.createElement("button");
      t.className = "tab" + (ch.id===state.activeChannelId ? " active" : "");
      t.textContent = ch.name;
      t.onclick = async () => { state.activeChannelId = ch.id; saveLocal(state); render(); await pushToCloud(); };
      tabsEl.appendChild(t);
    });

    const ch = activeChannel();
    const rawBosses = ch.bosses || [];
    const bosses = sortBosses(uiPref.onlyFav ? rawBosses.filter(b => b.starred) : rawBosses);

    listEl.innerHTML = "";
    if(bosses.length === 0){
      const empty = document.createElement("div");
      empty.className = "tiny muted";
      empty.textContent = uiPref.onlyFav
        ? "ä½ å·²é–‹å•Ÿã€Œåªçœ‹æ”¶è—ã€ï¼Œä½†æ­¤åˆ†æµæ²’æœ‰æ”¶è—çš„ BOSSã€‚"
        : "é€™å€‹åˆ†æµé‚„æ²’æœ‰ BOSSï¼Œé»ã€Œï¼‹æ–°å¢ BOSSã€é–‹å§‹ã€‚";
      listEl.appendChild(empty);
    }else{
      bosses.forEach(b => listEl.appendChild(renderBossItem(ch, b)));
    }

    // âœ… å…ˆæ¸²æŸ“æœ€è¿‘é‡ç”Ÿ
    renderRecentRespawns();

    // â­ æ”¶è—
    const starred = allStarred();
    favCount.textContent = starred.length;
    favBox.innerHTML = "";
    if(starred.length === 0){
      const e = document.createElement("div");
      e.className = "tiny muted"; e.style.marginTop = "10px";
      e.textContent = "é‚„æ²’æœ‰æ”¶è—ã€‚é» BOSS åç¨±æ—é‚Šçš„ â˜† ä¾†æ”¶è—ã€‚";
      favBox.appendChild(e);
    }else{
      for(const {ch, b} of starred){
        const row = document.createElement("div");
        row.className = "favitem";
        const left = document.createElement("div");
        left.className = "left";
        left.innerHTML = `
          <div style="display:flex;gap:8px;align-items:center;min-width:0;flex-wrap:wrap">
            <span class="badge">${escapeHtml(ch.name)}</span>
            ${b.location ? `<span class="badge">${escapeHtml(b.location)}</span>` : ""}
            <b style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(b.name)}</b>
          </div>
          <div class="tiny mono">${fmtDuration(nextSpawn(b)-now())} <span class="muted">ï½œ</span> ${fmtTime(nextSpawn(b))}</div>
        `;
        const right = document.createElement("div");
        right.className = "actions";
        right.append(
          mkBtn("å‰å¾€", "btn", async () => { state.activeChannelId = ch.id; saveLocal(state); render(); await pushToCloud(); window.scrollTo({top:0,behavior:"smooth"}); }),
          mkBtn("å–æ¶ˆâ­", "btn", async () => { b.starred=false; saveLocal(state); render(); await pushToCloud(); })
        );
        row.append(left, right);
        favBox.appendChild(row);
      }
    }
  }

  function renderBossItem(ch, b){
    const item = document.createElement("div");
    item.className = "item";
    const meta = document.createElement("div");
    meta.className = "meta";

    const nameRow = document.createElement("div");
    nameRow.className = "nameRow";

    const star = document.createElement("span");
    star.className = "star " + (b.starred ? "on" : "off");
    star.textContent = b.starred ? "â­" : "â˜†";
    star.title = b.starred ? "å–æ¶ˆæ”¶è—" : "æ”¶è—";
    star.onclick = async () => { b.starred = !b.starred; saveLocal(state); render(); await pushToCloud(); };

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = b.name;

    const locBadge = document.createElement("span");
    locBadge.className = "badge";
    locBadge.textContent = b.location ? b.location : "ï¼ˆæœªå¡«åœ°å€ï¼‰";

    const m = respawnMin(b);
    const timeBadge = document.createElement("span");
    timeBadge.className = "badge";
    timeBadge.textContent = m>0 ? `${m} åˆ†` : `éœ€æ‰‹å‹•`;

    nameRow.append(star, name, locBadge, timeBadge);

    const cd = document.createElement("div");
    cd.className = "countdown";
    const tNext = nextSpawn(b);
    const remain = tNext - now();
    cd.textContent = `${fmtDuration(remain)}  ï½œ  ${fmtTime(tNext)}`;

    const sub = document.createElement("div");
    sub.className = "tiny";
    sub.textContent = `ä¸Šæ¬¡æ“Šæ®ºï¼š${b.lastKillAt ? fmtTime(b.lastKillAt) : "æœªè¨­å®š"}`;

    const status = document.createElement("div");
    status.className = "tiny";
    const st = computeStatus(remain, state.settings.notifyBeforeMin);
    const note = (b.note || "").trim();
    status.innerHTML = `ç‹€æ…‹ï¼š<span class="badge ${st.cls}">${st.text}</span>` + (note ? ` <span class="muted">ï½œ</span> <span class="muted">${escapeHtml(note)}</span>` : "");
    meta.append(nameRow, cd, sub, status);

    const actions = document.createElement("div");
    actions.className = "actions";

    actions.append(
      mkBtn("æ“Šæ®º", "btn good", async () => {
        b.lastKillAt = now();
        b.notified = false;

        // âœ… é»æ“Šæ®ºï¼šä»£è¡¨å·²è™•ç†ï¼Œç§»å‡ºæœ€è¿‘é‡ç”Ÿ
        delete b._recentShownAt;
        delete b._recentIgnored;

        saveLocal(state); render(); await pushToCloud();
      }),
      mkBtn("æ‰‹å‹•è¨­å®š", "btn", async () => {
        const ts = await openTimePicker(b.lastKillAt);
        if(!ts) return;
        b.lastKillAt = ts;
        b.notified = false;

        // æ‰‹å‹•è¨­å®šä¹Ÿè¦–ç‚ºå·²è™•ç† â†’ ç§»å‡ºæœ€è¿‘é‡ç”Ÿ
        delete b._recentShownAt;
        delete b._recentIgnored;

        saveLocal(state); render(); await pushToCloud();
      }),
      mkBtn("ç·¨è¼¯", "btn primary", async () => {
        const newName = prompt("BOSS åç¨±ï¼ˆç¹ä¸­ï¼‰ï¼š", b.name);
        if(newName === null) return;
        const newLoc = prompt("å‡ºç¾åœ°å€ï¼ˆä½ç½®ï¼‰ï¼š", b.location || "");
        if(newLoc === null) return;
        const baseMin = prompt("å¹³å¸¸é‡ç”Ÿï¼ˆåˆ†é˜ï¼Œ0=éœ€æ‰‹å‹•ï¼‰ï¼š", String(b.baseMin ?? 0));
        if(baseMin === null) return;
        const eventMin = prompt("æ´»å‹•é‡ç”Ÿï¼ˆåˆ†é˜ï¼Œ0=éœ€æ‰‹å‹•ï¼‰ï¼š", String(b.eventMin ?? 0));
        if(eventMin === null) return;
        const newNote = prompt("å‚™è¨»ï¼ˆå¯ç•™ç©ºï¼‰ï¼š", b.note || "");
        if(newNote === null) return;

        const bM = Number(baseMin), eM = Number(eventMin);
        if(!Number.isFinite(bM) || bM < 0 || !Number.isFinite(eM) || eM < 0){
          alert("åˆ†é˜æ•¸è«‹è¼¸å…¥ 0 æˆ–æ­£æ•´æ•¸"); return;
        }

        b.name = (newName.trim() || b.name);
        b.location = (newLoc.trim());
        b.baseMin = Math.round(bM);
        b.eventMin = Math.round(eM);
        b.note = newNote.trim();
        b.notified = false;

        // ç·¨è¼¯å¾Œç§»å‡ºæœ€è¿‘é‡ç”Ÿ
        delete b._recentShownAt;
        delete b._recentIgnored;

        saveLocal(state); render(); await pushToCloud();
      }),
      mkBtn("åˆªé™¤", "btn danger", async () => {
        if(!confirm(`åˆªé™¤ã€Œ${b.name}ã€ï¼Ÿ`)) return;
        ch.bosses = ch.bosses.filter(x => x.id !== b.id);
        saveLocal(state); render(); await pushToCloud();
      })
    );

    item.append(meta, actions);
    return item;
  }

  // =========================
  // æ§åˆ¶é …
  // =========================
  document.querySelector("#btnResetLocal").onclick = () => {
    if(!confirm("é‡ç½®æœ¬æ©Ÿè³‡æ–™ï¼Ÿï¼ˆä¸æœƒåˆªé›²ç«¯æˆ¿é–“ï¼‰")) return;
    localStorage.removeItem(LOCAL_KEY);
    state = defaultState();
    saveLocal(state);
    render();
  };

  chkSound.onchange = async () => { state.settings.soundEnabled = chkSound.checked; saveLocal(state); render(); await pushToCloud(); };
  chkEvent.onchange = async () => {
    state.settings.eventMode = chkEvent.checked;
    for(const ch of state.channels) for(const b of ch.bosses) b.notified = false;
    saveLocal(state); render(); await pushToCloud();
  };
  rngVol.oninput = async () => { state.settings.volume = Math.max(0, Math.min(1, Number(rngVol.value)/100)); saveLocal(state); };
  btnMute.onclick = async () => { state.settings.muted = !state.settings.muted; saveLocal(state); render(); await pushToCloud(); };
  notifyMin.onchange = async () => {
    const v = Number(notifyMin.value);
    state.settings.notifyBeforeMin = Number.isFinite(v) ? Math.max(0, Math.min(180, Math.round(v))) : 3;
    for(const ch of state.channels) for(const b of ch.bosses) b.notified = false;
    saveLocal(state); render(); await pushToCloud();
  };

  selFont.onchange = () => { uiPref.font = selFont.value; saveUI(uiPref); render(); };
  chkOnlyFav.onchange = () => { uiPref.onlyFav = chkOnlyFav.checked; saveUI(uiPref); render(); };
  selSoundWarn.onchange = () => { uiPref.soundWarn = selSoundWarn.value; saveUI(uiPref); render(); };
  selSoundSpawn.onchange = () => { uiPref.soundSpawn = selSoundSpawn.value; saveUI(uiPref); render(); };

  document.querySelector("#btnAddBoss").onclick = async () => {
    const name = prompt("BOSS åç¨±ï¼ˆç¹ä¸­ï¼‰ï¼š", "æ–°BOSS");
    if(name === null) return;
    const loc = prompt("å‡ºç¾åœ°å€ï¼ˆä½ç½®ï¼‰ï¼š", "");
    if(loc === null) return;
    const baseMin = prompt("å¹³å¸¸é‡ç”Ÿï¼ˆåˆ†é˜ï¼Œ0=éœ€æ‰‹å‹•ï¼‰ï¼š", "60");
    if(baseMin === null) return;
    const eventMin = prompt("æ´»å‹•é‡ç”Ÿï¼ˆåˆ†é˜ï¼Œ0=éœ€æ‰‹å‹•ï¼‰ï¼š", "30");
    if(eventMin === null) return;
    const note = prompt("å‚™è¨»ï¼ˆå¯ç•™ç©ºï¼‰ï¼š", "");
    if(note === null) return;

    const bM = Number(baseMin), eM = Number(eventMin);
    if(!Number.isFinite(bM) || bM < 0 || !Number.isFinite(eM) || eM < 0){
      alert("åˆ†é˜æ•¸è«‹è¼¸å…¥ 0 æˆ–æ­£æ•´æ•¸"); return;
    }

    const ch = activeChannel();
    ch.bosses.push({
      id: uid("b"),
      name: name.trim()||"æ–°BOSS",
      baseMin: Math.round(bM),
      eventMin: Math.round(eM),
      location: loc.trim(),
      note: note.trim(),
      lastKillAt: now(),
      starred:false,
      notified:false
    });
    saveLocal(state); render(); await pushToCloud();
  };

  document.querySelector("#btnAddChannel").onclick = async () => {
    const name = prompt("åˆ†æµåç¨±ï¼š", `è‡ªè¨‚åˆ†æµ ${state.channels.length+1}`);
    if(name === null) return;
    const ch = { id: uid("ch"), name: (name.trim() || `è‡ªè¨‚åˆ†æµ ${state.channels.length+1}`), bosses: [] };
    state.channels.push(ch);
    state.activeChannelId = ch.id;
    saveLocal(state); render(); await pushToCloud();
  };

  // =========================
  // æé†’ + æœ€è¿‘é‡ç”Ÿï¼šåˆ·æ–°å¾Œ 15 ç§’è‡ªå‹•é–‹å§‹å€’æ•¸ï¼Œä½†ä»ä¿ç•™æœ€è¿‘é‡ç”Ÿç›´åˆ° 10 åˆ†é˜è‡ªå‹•å¿½ç•¥
  // =========================
  function checkAlerts(){
    const notifyBeforeMin = state.settings.notifyBeforeMin ?? 0;
    const notifyMs = notifyBeforeMin * 60 * 1000;

    const AUTO_START_MS = 15 * 1000;      // âœ… åˆ·æ–°å¾Œ 15 ç§’è‡ªå‹•é–‹å§‹ä¸‹ä¸€è¼ªå€’æ•¸
    const AUTO_IGNORE_MS = 10 * 60 * 1000; // âœ… ä¿®æ­£ï¼šæœ€è¿‘é‡ç”Ÿä¿ç•™ 10 åˆ†é˜å¾Œè‡ªå‹•å¿½ç•¥

    let changed = false;
    const t = now();

    for(const ch of state.channels){
      for(const b of ch.bosses){
        const m = respawnMin(b);
        if(m <= 0) continue;

        const tNext = nextSpawn(b);
        const remain = tNext - t;

        // å³å°‡åˆ·æ–°æé†’ï¼ˆåªæé†’ä¸€æ¬¡ï¼‰
        if(remain > 0 && remain <= notifyMs && !b.notified){
          b.notified = true;
          beep("warn");
          changed = true;
        }

        if(remain <= 0){
          // âœ… åˆ·æ–°ç¬é–“ï¼šåŠ å…¥ã€Œæœ€è¿‘é‡ç”Ÿã€ï¼ˆåªåšä¸€æ¬¡ï¼‰
          if(!b._recentShownAt && !b._recentIgnored){
            b._recentShownAt = t;
            beep("spawn");
            changed = true;
          }

          // âœ… è¶…é 15 ç§’ï¼šè‡ªå‹•é–‹å§‹ä¸‹ä¸€è¼ªå€’æ•¸ï¼ˆä½†ä¸ç§»å‡ºæœ€è¿‘é‡ç”Ÿï¼‰
          if(b._recentShownAt && (t - b._recentShownAt >= AUTO_START_MS)){
            // é¿å…æ¯ç§’ä¸€ç›´é‡ç½®ï¼šåªåšä¸€æ¬¡ï¼ˆlastKillAt æ¨åˆ°è¿‘ç¾åœ¨ï¼‰
            if(Math.abs((b.lastKillAt ?? 0) - t) > 2000){
              b.lastKillAt = t;
              b.notified = false;
              changed = true;
            }
          }

          // âœ… è¶…é 10 åˆ†é˜ï¼šè‡ªå‹•å¿½ç•¥ç§»å‡ºæœ€è¿‘é‡ç”Ÿ
          if(b._recentShownAt && (t - b._recentShownAt >= AUTO_IGNORE_MS)){
            b._recentIgnored = true;
            delete b._recentShownAt;
            changed = true;
          }
        }
      }
    }

    if(changed){
      saveLocal(state);
      pushToCloud();
      render();
    }
  }

  // =========================
  // æˆ¿é–“åŠ å…¥/é€£çµï¼ˆåŠ å…¥æ—¢æœ‰æˆ¿é–“ä¸è¦†è“‹ + UI lock + åŠ å…¥åº/æˆ¿ä¸»/ç·šä¸Šï¼‰
  // =========================
  const roomInput = document.querySelector("#roomId");
  const joinBtn = document.querySelector("#btnJoin");
  const copyBtn = document.querySelector("#btnCopyLink");

  function getRoomFromURL(){
    const u = new URL(location.href);
    const r = u.searchParams.get("room");
    return r ? r.trim() : "";
  }

  joinBtn.onclick = async () => {
    const r = (roomInput.value || "").trim();
    if(!r || r.length < 3){
      alert("Room ID è‡³å°‘ 3 å­—å…ƒ");
      return;
    }

    if(unsubRoom){ unsubRoom(); unsubRoom = null; }
    stopPresence();

    roomId = r;

    setLocked(true, "æ­£åœ¨é€£ç·š/å»ºç«‹æˆ¿é–“â€¦");
    setCloudStatus("æ­£åœ¨é€£ç·šæˆ¿é–“â€¦", null);

    try{
      const existed = await ensureRoomAndJoinMeta();
      setCloudStatus(existed ? "å·²åŠ å…¥æˆ¿é–“ï¼Œæ­£åœ¨åŒæ­¥è³‡æ–™â€¦" : "å·²å»ºç«‹æ–°æˆ¿é–“ï¼Œåˆå§‹åŒ–ä¸­â€¦", null);

      startRoomListen();
      await startPresence();

      // åªåœ¨é€™è£¡æ›´æ–° URL
      const u = new URL(location.href);
      u.searchParams.set("room", roomId);
      history.replaceState(null, "", u.toString());

      render();
    }catch(e){
      console.error(e);
      setCloudStatus("åŠ å…¥å¤±æ•—ï¼ˆè«‹æª¢æŸ¥ Firebase Rules/Consoleï¼‰", false);
      setLocked(false);
    }
  };

  copyBtn.onclick = async () => {
    const r = roomId || (roomInput.value || "").trim();
    if(!r){ alert("å…ˆè¼¸å…¥ Room ID"); return; }
    const u = new URL(location.href);
    u.searchParams.set("room", r);
    await navigator.clipboard.writeText(u.toString());
    alert("å·²è¤‡è£½æˆ¿é–“é€£çµï¼");
  };

  // init
  document.querySelector("#roleLabel").textContent = "â€”";
  document.querySelector("#joinIndexLabel").textContent = "â€”";
  document.querySelector("#onlineLabel").textContent = "0";
  setCloudStatus("æœªé€£ç·š", false);

  const urlRoom = getRoomFromURL();
  if(urlRoom) roomInput.value = urlRoom;

  render();
  // æ¯ç§’æ›´æ–° UI å’Œæª¢æŸ¥æé†’
  setInterval(() => { checkAlerts(); render(); }, 1000);

  // è§£é–éŸ³æ•ˆï¼ˆç€è¦½å™¨è¦å®šï¼šéœ€ä½¿ç”¨è€…äº’å‹•ï¼‰
  window.addEventListener("pointerdown", () => {
    if (audioCtx && audioCtx.state === "suspended") audioCtx.resume();
  }, { once: false });
</script>
</body>
</html>
